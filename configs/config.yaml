# Sample configuration for the refactored Service Layer runtime.
# All sections are optional â€“ omit what you do not need.

server:
  host: "0.0.0.0"
  port: 8080

database:
  driver: "postgres"
  dsn: "postgres://supabase_admin:supabase_pass@localhost:5432/service_layer?sslmode=disable"
  max_open_conns: 10
  max_idle_conns: 5
  conn_max_lifetime: 300
  # Set to true to run migrations automatically on startup (requires PostgreSQL).
  migrate_on_start: true

logging:
  level: "info"   # debug, info, warn, error
  format: "text"  # text, json
  output: "stdout"
  file_prefix: "service-layer"

runtime:
  bus_permissions: {}
  module_deps: {}
  unknown_modules_strict: true
  require_apis_strict: false
  tee:
    # Controls which executor backend the function runtime uses ("mock" to
    # force the in-process mock TEE; any other value enables the enclave
    # executor wiring).
    mode: ""
  # Threshold (milliseconds) for flagging slow module start/stop in /system/status, CLI, and dashboard.
  slow_module_threshold_ms: 1000
  random:
    # Optional base64/hex encoded ed25519 private key for deterministic random
    # signatures. Leave empty to auto-generate ephemeral keys on startup
    # (NOT recommended for production; set a persistent key to keep signatures stable).
    signing_key: ""
  pricefeed:
    # Configure the HTTP fetcher for refreshing price feeds. Leave fetch_url
    # empty to disable the refresher.
    fetch_url: ""
    fetch_key: ""
  gasbank:
    # Configure the asynchronous gas bank settlement poller. Leave resolver_url
    # empty to disable settlement polling.
    resolver_url: ""
    resolver_key: ""
    # Tuning knobs for settlement retries and polling cadence.
    poll_interval: "15s"
    max_attempts: 5
  oracle:
    # Optional TTL for oracle requests (seconds). Zero disables TTL expiry.
    ttl_seconds: 0
    # Maximum resolver attempts before DLQ.
    max_attempts: 3
    # Backoff between attempts (duration string).
    backoff: "10s"
    # Enable dead-lettering for exhausted/expired requests.
    dlq_enabled: true
    # Optional list of tokens required for runner callbacks (X-Oracle-Runner-Token).
    runner_tokens: []
  datafeeds:
    # Minimum signer threshold for feed definitions (0 to disable).
    min_signers: 0
    # Default aggregation strategy for submissions (median|mean|min|max).
    aggregation: "median"
  # Bus payload cap for /system/events|data|compute. Prefer env override BUS_MAX_BYTES.
  bus_max_bytes: 1048576
  cre:
    # Set to true to enable the HTTP CRE runner.
    http_runner: false
  neo:
    # Enable the Neo node/indexer modules (neo-go RPC + indexer HTTP).
    enabled: false
    rpc_url: "http://localhost:10332"
    network: "testnet"
    indexer_url: "http://localhost:8080/neo/status"
  chains:
    # Enable the multi-chain RPC hub (btc/eth/neox/etc.).
    enabled: false
    # Enforce tenancy and rate limits on /system/rpc.
    require_tenant: false
    per_tenant_per_minute: 0
    per_token_per_minute: 0
    burst: 3
    allowed_methods:
      eth: ["eth_blockNumber", "eth_getBalance"]
    endpoints:
      eth: "https://sepolia.infura.io/v3/<key>"
      btc: "https://mempool.space/testnet/api/v1/blocks"
      neox: "http://localhost:1234"
  data_sources:
    # Enable shared data source hub (feeds/oracle/trigger sources).
    enabled: false
    sources:
      coingecko: "https://api.coingecko.com/api/v3/ping"
      example: "https://example.com/healthz"
  contracts:
    # Enable contract deployment/invocation module.
    enabled: false
    network: "neo-testnet"
  crypto:
    # Enable crypto engine (ZKP/FHE/MPC helpers).
    enabled: false
    endpoint: ""
    capabilities: ["zkp", "fhe", "mpc"]
  rocketmq:
    # Enable RocketMQ-backed event bus.
    enabled: false
    name_servers: ["127.0.0.1:9876"]
    access_key: ""
    secret_key: ""
    topic_prefix: "sl"
    consumer_group: "sl-consumers"
    namespace: ""
    max_reconsume_times: 16
    consume_batch: 1
    consume_from: "latest" # latest|first
  service_bank:
    # Enable service-layer-owned GAS bank controller.
    enabled: false

auth:
  # Static bearer tokens accepted by the HTTP API. Combine with the
  # API_TOKENS / API_TOKEN environment variables for runtime overrides.
  tokens:
    - "dev-token"   # Local-only default; override in production.
  # Validate JWTs issued by your self-hosted Supabase (GoTrue). When set,
  # bearer tokens remain accepted and /auth/login will also reuse this secret
  # if jwt_secret is empty.
  supabase_jwt_secret: "super-secret-jwt"
  # Optional audience to enforce (matches Supabase default).
  supabase_jwt_aud: "authenticated"
  # Optional list of Supabase roles treated as admin inside the Service Layer.
  supabase_admin_roles: ["service_role", "admin"]
  # Optional claim path (supports dot notation, e.g., app_metadata.tenant) to
  # derive the tenant from Supabase JWTs when X-Tenant-ID is absent.
  supabase_tenant_claim: "app_metadata.tenant"
  # Optional claim path to derive the role from Supabase JWTs (dot notation).
  supabase_role_claim: "app_metadata.role"
  # Optional GoTrue base URL for refresh token proxy (/auth/refresh).
  supabase_gotrue_url: "http://supabase-gotrue:9999"
  # JWT secret and users enable /auth/login for dashboard/console logins.
  jwt_secret: "change-me-jwt-secret"
  users:
    - username: "admin"
      password: "changeme"
      role: "admin"

security:
  # Secret encryption key used for vault storage. Required when using
  # persistent stores (e.g. PostgreSQL). Accepts raw, base64, or hex-encoded
  # 16/24/32 byte AES keys.
  secret_encryption_key: ""
