using System.Numerics;
using Neo;
using Neo.SmartContract.Framework;
using Neo.SmartContract.Framework.Services;

namespace NeoMiniAppPlatform.Contracts
{
    public partial class MiniAppCompoundCapsule
    {
        #region Internal Helpers

        private static void StoreCapsule(BigInteger capsuleId, Capsule capsule)
        {
            Storage.Put(Storage.CurrentContext,
                Helper.Concat((ByteString)PREFIX_CAPSULES, (ByteString)capsuleId.ToByteArray()),
                StdLib.Serialize(capsule));
        }

        private static BigInteger GetApyForLockDays(BigInteger days)
        {
            if (days >= TIER4_DAYS) return TIER4_APY_BPS;
            if (days >= TIER3_DAYS) return TIER3_APY_BPS;
            if (days >= TIER2_DAYS) return TIER2_APY_BPS;
            return TIER1_APY_BPS;
        }

        private static void AddUserCapsule(UInt160 user, BigInteger capsuleId)
        {
            byte[] countKey = Helper.Concat(PREFIX_USER_CAPSULE_COUNT, user);
            BigInteger count = (BigInteger)Storage.Get(Storage.CurrentContext, countKey);
            Storage.Put(Storage.CurrentContext, countKey, count + 1);

            byte[] key = Helper.Concat(
                Helper.Concat(PREFIX_USER_CAPSULES, user),
                (ByteString)count.ToByteArray());
            Storage.Put(Storage.CurrentContext, key, capsuleId);
        }

        private static void UpdateTotalLocked(BigInteger amount, bool isDeposit)
        {
            BigInteger total = TotalLocked();
            if (isDeposit)
                Storage.Put(Storage.CurrentContext, PREFIX_TOTAL_LOCKED, total + amount);
            else
                Storage.Put(Storage.CurrentContext, PREFIX_TOTAL_LOCKED, total - amount);
        }

        private static void UpdateUserEarned(UInt160 user, BigInteger amount)
        {
            byte[] key = Helper.Concat(PREFIX_USER_TOTAL_EARNED, user);
            BigInteger earned = (BigInteger)Storage.Get(Storage.CurrentContext, key);
            Storage.Put(Storage.CurrentContext, key, earned + amount);
        }
        private static void CompoundCapsuleYield(BigInteger capsuleId)
        {
        }
        }

        private static void StoreUserStats(UInt160 user, UserStats stats)
        {
            Storage.Put(Storage.CurrentContext,
                Helper.Concat((ByteString)PREFIX_USER_STATS, user),
                StdLib.Serialize(stats));
        }

        #endregion
    }
}
