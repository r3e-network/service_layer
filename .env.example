# =============================================================================
# Neo Service Layer - Environment Configuration
# MarbleRun + EGo + Supabase + Vercel Architecture
# =============================================================================

# =============================================================================
# Supabase Configuration
# =============================================================================
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_ANON_KEY=your-anon-key
# Supabase service role key. For compatibility:
# - Go services typically use `SUPABASE_SERVICE_KEY`
# - Supabase Edge functions typically use `SUPABASE_SERVICE_ROLE_KEY`
SUPABASE_SERVICE_KEY=your-service-key
SUPABASE_SERVICE_ROLE_KEY=your-service-key
# Optional override for PostgREST base path (default: /rest/v1).
SUPABASE_REST_PREFIX=/rest/v1
# Allow http:// Supabase URLs in dev/test only.
SUPABASE_ALLOW_INSECURE=false

# PostgreSQL Direct Connection (SSL Required)
POSTGRES_HOST=db.your-project.supabase.co
POSTGRES_PORT=5432
POSTGRES_DB=postgres
POSTGRES_USER=postgres
POSTGRES_PASSWORD=your-password
POSTGRES_SSLMODE=verify-full

# =============================================================================
# MarbleRun Coordinator Configuration
# =============================================================================
# Address marbles use to reach the coordinator mesh port.
# - Docker Compose: use the service DNS name (default network)
# - Kubernetes: use the Service DNS name (e.g. marblerun-coordinator.marblerun.svc.cluster.local:2001)
COORDINATOR_MESH_ADDR=coordinator:2001
COORDINATOR_CLIENT_ADDR=localhost:4433
MANIFEST_PATH=/app/manifests/manifest.json

# =============================================================================
# EGo/SGX Configuration
# =============================================================================
# Set to 1 for simulation mode (development)
# Set to 0 for SGX hardware (production)
OE_SIMULATION=1

# =============================================================================
# Server Configuration
# =============================================================================
MARBLE_ENV=development
PORT=8080
METRICS_PORT=9090
DEBUG=false

# Service selection (cmd/marble)
# MarbleRun sets `MARBLE_TYPE` for each Marble automatically.
# For local debugging, you can set `SERVICE_TYPE` instead:
# SERVICE_TYPE=neocompute
# MARBLE_TYPE=neocompute

# Logging
LOG_LEVEL=info
LOG_FORMAT=json

# Metrics exposure toggle (see infrastructure/metrics)
# - production: disabled unless explicitly enabled
# - non-production: enabled unless explicitly disabled
# METRICS_ENABLED=true

# =============================================================================
# Secrets (Shared: Supabase Edge + TEE services)
# =============================================================================
# Secrets encryption master key (hex-encoded 32 bytes).
# Required for secrets management and secret injection into services.
# Generate with `openssl rand -hex 32`
SECRETS_MASTER_KEY=
# AccountPool master key (hex-encoded 32 bytes).
# Required to keep pool accounts derivable across restarts.
# Generate with `openssl rand -hex 32`
POOL_MASTER_KEY=
# Optional: coordinator seed (hex-encoded 16+ bytes) used to derive POOL_MASTER_KEY.
# COORD_MASTER_SEED=

# AccountPool encryption key (hex-encoded 32 bytes).
# Required for pre-generated accounts with stored encrypted WIFs.
# Generate with `openssl rand -hex 32`
POOL_ENCRYPTION_KEY=

# Optional: if set, enclave services require an explicit per-secret allowlist
# entry (secret_policies) for access. When unset, empty allowlists are treated
# as "allow all services" for backward compatibility.
# SECRETS_STRICT_PERMISSIONS=true

# =============================================================================
# Neo N3 Configuration
# =============================================================================
# Optional: comma-separated list of RPC endpoints (used by cmd/marble if set).
# If unset, `NEO_RPC_URL` is used.
# NEO_RPC_URLS=https://testnet1.neo.coz.io:443,https://testnet2.neo.coz.io:443
NEO_RPC_URL=https://testnet1.neo.coz.io:443
NEO_NETWORK_MAGIC=894710606

# Neo N3 Testnet Account (for Fairy tests and contract deployment)
NEO_TESTNET_WIF=your-testnet-wif-here
NEO_TESTNET_ADDRESS=your-testnet-address-here
NEO_TESTNET_PUBKEY=your-testnet-pubkey-here

# =============================================================================
# Neo N3 Contract Addresses
# Deploy contracts with: go run ./cmd/deploy-fairy/main.go
# =============================================================================
# MiniApp platform contracts
CONTRACT_PAYMENTHUB_HASH=0x0000000000000000000000000000000000000000
CONTRACT_GOVERNANCE_HASH=0x0000000000000000000000000000000000000000
CONTRACT_PRICEFEED_HASH=0x0000000000000000000000000000000000000000
CONTRACT_RANDOMNESSLOG_HASH=0x0000000000000000000000000000000000000000
CONTRACT_APPREGISTRY_HASH=0x0000000000000000000000000000000000000000
CONTRACT_AUTOMATIONANCHOR_HASH=0x0000000000000000000000000000000000000000
CONTRACT_SERVICEGATEWAY_HASH=0x0000000000000000000000000000000000000000
# Optional: sample MiniApp consumer contract for callback validation scripts.
CONTRACT_MINIAPP_CONSUMER_HASH=

# Fairy RPC for local testing
FAIRY_RPC_URL=http://127.0.0.1:16868

# =============================================================================
# Service routing (Supabase Edge + internal mesh)
# =============================================================================
# These are the service URLs the Supabase Edge functions call. In production you
# should use HTTPS + mTLS with MarbleRun/attested TLS.
#
# Local development options:
# - When the marbles run in Docker Compose: use `http://<service-name>:<port>` (default below).
# - When using the local Edge dev server on the host (`make edge-dev`): use `http://localhost:<port>`
#   (simulation compose exposes these ports on 127.0.0.1).
NEOFEEDS_URL=http://neofeeds:8083
NEOCOMPUTE_URL=http://neocompute:8086
NEOVRF_URL=http://neovrf:8087
NEOORACLE_URL=http://neooracle:8088
NEOFLOW_URL=http://neoflow:8084
TXPROXY_URL=http://txproxy:8090
# TxProxy client timeout (Go duration). Increase if waiting for confirmations.
TXPROXY_TIMEOUT=90s
# GasBank service URL (optional; enables fee deduction for services).
GASBANK_URL=http://neogasbank:8091
# Account pool service URL (used by GasBank/Simulation).
NEOACCOUNTS_SERVICE_URL=http://neoaccounts:8085
# NeoRequests dispatcher controls (optional)
NEOREQUESTS_MAX_RESULT_BYTES=800
NEOREQUESTS_MAX_ERROR_LEN=256
# NEOREQUESTS_ENFORCE_APPREGISTRY=true
# NEOREQUESTS_APPREGISTRY_CACHE_SECONDS=60
# NEOREQUESTS_RNG_RESULT_MODE=raw
# NEOREQUESTS_TX_WAIT=true
# GasBank deposit address (public)
GASBANK_DEPOSIT_ADDRESS=
# Optional: enable automatic pool account top-ups via NeoAccounts /fund.
# TOPUP_ENABLED=true

# AccountPool persistence controls
# Allow ephemeral master key only for local experiments (accounts unrecoverable).
NEOACCOUNTS_ALLOW_EPHEMERAL_MASTER_KEY=false
# Delete retiring accounts once balances reach zero (default: keep for audit).
NEOACCOUNTS_DELETE_RETIRING_ACCOUNTS=false

# =============================================================================
# Supabase Edge (Gateway) rate limiting
# =============================================================================
# The gateway implements fixed-window rate limiting backed by the Postgres
# `rate_limits` table and the `rate_limit_bump(...)` RPC.
#
# Global defaults:
# EDGE_RATELIMIT_DEFAULT_PER_MINUTE=60
# EDGE_RATELIMIT_WINDOW_SECONDS=60
#
# Per-endpoint overrides use the Edge function name uppercased with hyphens
# replaced by underscores:
# EDGE_RATELIMIT_PAY_GAS_PER_MINUTE=10
# EDGE_RATELIMIT_VOTE_NEO_PER_MINUTE=10

# Optional: browser CORS allowlist (comma/space-separated origins). When unset,
# Edge functions return `Access-Control-Allow-Origin: *` for compatibility.
# EDGE_CORS_ORIGINS=http://localhost:3000 https://your-host-app.vercel.app

# Optional: service-to-service signer routing (preferred over distributing keys).
# When set, marbles (except `globalsigner`) will delegate signing to GlobalSigner.
# GLOBALSIGNER_SERVICE_URL=https://globalsigner:8092

# Optional: chain event listener start height (defaults to current height-1).
# NEO_EVENT_START_BLOCK=0

# Oracle outbound URL allowlist (comma-separated prefixes)
# Required in production/SGX mode. Examples:
# ORACLE_HTTP_ALLOWLIST=https://api.binance.com,https://api.coinbase.com
ORACLE_HTTP_ALLOWLIST=https://api.binance.com,https://api.coinbase.com

# NeoOracle request controls (optional)
# - ORACLE_TIMEOUT: Go duration (e.g. 20s, 1m)
# - ORACLE_MAX_SIZE: max response size in bytes (supports KiB/MiB/GiB suffixes)
ORACLE_TIMEOUT=20s
ORACLE_MAX_SIZE=2MiB

# NeoCompute execution result retention (optional; default 24h)
# NEOCOMPUTE_RESULT_TTL=24h

# TxProxy allowlist (JSON). Default is deny-all when unset.
# Method names must match Neo devpack manifest names (lowerCamelCase).
# Minimal platform allowlist example:
# TXPROXY_ALLOWLIST='{"contracts":{"<paymentHubHash>":["pay"],"<governanceHash>":["stake","unstake","vote"],"<priceFeedHash>":["update"],"<randomnessLogHash>":["record"],"<automationAnchorHash>":["markExecuted"],"<serviceGatewayHash>":["fulfillRequest"]}}'
# For automation target contracts, add them explicitly (or use "*" per contract, not recommended).
TXPROXY_ALLOWLIST=

# NeoFlow webhook security (production/SGX)
# External webhooks are blocked from targeting private/loopback/link-local networks by default.
# Set to true only if you need to call private endpoints (not recommended).
NEOFLOW_WEBHOOK_ALLOW_PRIVATE_NETWORKS=false

# NeoFlow scheduler hydration (optional)
# If set, the scheduler will hydrate Supabase triggers for this user ID on startup.
# (Intended to be injected via MarbleRun secrets in production.)
# NEOFLOW_SCHEDULER_USER_ID=

# AutomationAnchor anchored tasks (optional)
# Comma-separated task IDs to load from the on-chain `AutomationAnchor` registry.
# Each entry can be either:
# - plain ASCII (stored as bytes), or
# - hex bytes (0x...).
NEOFLOW_TASK_IDS=

# Simulation service (optional)
# SIMULATION_ENABLED=true
# SIMULATION_MINIAPPS=builtin-lottery,builtin-coin-flip,builtin-dice-game
# SIMULATION_TX_INTERVAL_MIN_MS=1000
# SIMULATION_TX_INTERVAL_MAX_MS=5000
# SIMULATION_WORKERS_PER_APP=2

# Binance API
BINANCE_API_KEY=your_binance_api_key_here

# Arbitrum RPC for Chainlink price feeds
ARBITRUM_RPC=https://arb1.arbitrum.io/rpc

# =============================================================================
# Development-only signing keys (fallback)
# =============================================================================
# In production, use GlobalSigner (`GLOBALSIGNER_SERVICE_URL`) rather than
# distributing private keys to every enclave service.
#
# TEE_PRIVATE_KEY=hex_private_key_for_chain_signing
# TEE_WALLET_PRIVATE_KEY=hex_private_key_for_wallet_operations

# =============================================================================
# MarbleRun-injected identity & secrets (do not set manually)
# =============================================================================
# These are injected by MarbleRun/ego inside the enclave and are shown here for
# completeness and for debugging local simulations.
#
# MARBLE_CERT=
# MARBLE_KEY=
# MARBLE_ROOT_CA=
# MARBLE_EXTRA_CLIENT_CA=
# MARBLE_UUID=
# MARBLE_SECRETS=

# =============================================================================
# Supabase Edge â†’ TEE mTLS (optional)
# =============================================================================
# Edge functions will use mTLS when these PEM values are set.
#
# TEE_MTLS_CERT_PEM=
# TEE_MTLS_KEY_PEM=
# TEE_MTLS_ROOT_CA_PEM=
#
# Alternatively:
# MARBLERUN_ROOT_CA_PEM=
#
# RNG anchoring (optional): set to 1 to record RNG results on-chain via txproxy.
# RNG_ANCHOR=1

# =============================================================================
# Host App (Next.js) security configuration
# =============================================================================
# Space-separated list of allowed origins for embedded MiniApps (iframe frame-src).
# Example: "https://cdn.miniapps.com https://trusted-apps.miniapps.com"
# MINIAPP_FRAME_ORIGINS=
#
# Module Federation remotes for built-in MiniApps (comma-separated).
# Example: NEXT_PUBLIC_MF_REMOTES=builtin@https://cdn.miniapps.com/miniapps/builtin-mf
# Built-in manifests can use: mf://builtin?app=<app_id>
# NEXT_PUBLIC_MF_REMOTES=
#
# Used for CSP connect-src; typically your Supabase project URL.
# NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co

# Optional: Host-side /api/rpc/* proxy target (see platform/host-app/README.md).
# Prefer setting to the functions base URL:
# EDGE_BASE_URL=https://your-project.supabase.co/functions/v1
# EDGE_BASE_URL=http://localhost:8787/functions/v1
