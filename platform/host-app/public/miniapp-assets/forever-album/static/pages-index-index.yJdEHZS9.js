import{r as e,a,o as t,b as l,c as n,d as o,e as s,f as i,i as r,w as c,g as u,h as d,j as p,t as v,k as f,u as y,n as h,l as m,I as w,m as g,p as b,q as _,s as C,v as k,x as A,y as x,F as I,z as $,A as T,B as E,C as P,D as S,E as M,G as B}from"./index-DAJKs7dJ.js";import{A as z,s as F,w as N,g as V,a as R,N as D,b as U,_ as H,c as j,u as W,d as q,e as G,f as K}from"./useI18n.DOsDhmAe.js";class L extends Error{constructor(e,a){super(e),this.statusCode=a,this.name="HttpError"}}const O={maxRetries:3,baseDelayMs:1e3,maxDelayMs:1e4};function J(e,a){return Math.min(a.baseDelayMs*Math.pow(2,e),a.maxDelayMs)*(.75+.5*Math.random())}function Q(e,a){if(a&&a>=500)return!0;if(429===a)return!0;if(e instanceof Error){const a=e.message.toLowerCase();return a.includes("network")||a.includes("timeout")||a.includes("abort")}return!1}async function X(a,t){var l;if("undefined"!=typeof uni&&"function"==typeof e)return new Promise((l,n)=>{const o=(e=>{if(e){if(e instanceof Headers){const a={};return e.forEach((e,t)=>{a[t]=e}),a}return Array.isArray(e)?Object.fromEntries(e):e}})(t.headers),s=String((null==o?void 0:o["Content-Type"])||(null==o?void 0:o["content-type"])||"");let i=t.body;if("string"==typeof i&&s.includes("application/json"))try{i=JSON.parse(i)}catch{}e({url:a,method:t.method||"GET",data:i,header:o,success:e=>{var a,t;if((e.statusCode??0)>=200&&(e.statusCode??0)<300)l(e.data);else{const l=(null==(t=null==(a=e.data)?void 0:a.error)?void 0:t.message)||`Request failed: ${e.statusCode}`;n(new L(l,e.statusCode??0))}},fail:e=>{n(new Error(e.errMsg||"Network error"))}})});const n="undefined"!=typeof window&&a.startsWith(window.location.origin),o=await fetch(a,{credentials:n?"include":"same-origin",...t});if(!o.ok){const e=await o.json().catch(()=>({}));throw new L((null==(l=e.error)?void 0:l.message)||`Request failed: ${a}`,o.status)}return o.json()}async function Y(e){return async function(e,a={}){var t,l;const n=e.startsWith("http")?e:`${z}${e}`,o={...O,...a.retryConfig};let s=null;for(let r=0;r<=o.maxRetries;r++){if(null==(t=a.signal)?void 0:t.aborted)throw new Error("Request cancelled");try{return await X(n,a)}catch(i){s=i instanceof Error?i:new Error(String(i));const e=i instanceof L?i.statusCode:void 0;if(null==(l=a.signal)?void 0:l.aborted)throw s;if(r>=o.maxRetries)break;if(!Q(i,e))break;const t=J(r,o);await new Promise(e=>setTimeout(e,t))}}throw s||new Error("Request failed")}(e,{method:"GET"})}let Z=null;function ee(){const e=a(null),n=a({}),o=a(null),s=a(null),i=a(null),r=a([]),c=a(!1),u=a(!1),d=a(null),p=a(!1),v=a(null),f=a=>{a.connected&&a.address?(e.value=a.address,c.value=!0):(e.value=null,c.value=!1),o.value=a.chainId??null,s.value=a.chainType??null,n.value=(e=>{if(!e)return{};if(e.balances&&Object.keys(e.balances).length>0)return{...e.balances};if(e.balance){const a={};return a[e.balance.nativeSymbol||("neo-n3"===e.chainType?"GAS":"NATIVE")]=e.balance.native||"0",(e.balance.governance||e.balance.governanceSymbol)&&(a[e.balance.governanceSymbol||("neo-n3"===e.chainType?"NEO":"GOV")]=e.balance.governance||"0"),a}return{}})(a)},y=e=>{e&&(i.value=e.chainId??null,r.value=Array.isArray(e.supportedChains)?e.supportedChains:[])},h=async()=>{var e;const a=await N(),t=null==(e=a.getConfig)?void 0:e.call(a);return y(t),t},m=async e=>{const a=await N();if(!a.wallet.switchChain)throw new Error("switchChain not supported by SDK");await a.wallet.switchChain(e),o.value=e};let w=null;return t(()=>{const a=R();f(a),w=F(e=>{f(e)});const t=V();(null==t?void 0:t.getConfig)&&y(t.getConfig()),t&&!c.value&&(e=>e?(Z||(Z=e.wallet.getAddress().then(e=>e||null).catch(e=>{const a=e instanceof Error?e.message:String(e);return console.debug("[MiniApp SDK] Fallback wallet connection failed:",a),null}).finally(()=>{Z=null})),Z):Promise.resolve(null))(t).then(a=>{var l;if(!c.value&&a){e.value=a,c.value=!0;const n=null==(l=t.getConfig)?void 0:l.call(t);o.value=(null==n?void 0:n.chainId)??null,s.value=(null==n?void 0:n.chainType)??null,y(n)}}),N().then(e=>{var a;return y(null==(a=e.getConfig)?void 0:a.call(e))}).catch(()=>{})}),l(()=>{w&&w()}),{address:e,chainId:o,chainType:s,appChainId:i,supportedChains:r,balances:n,isConnected:c,isLoading:u,error:d,showConnectionPrompt:p,connectionPromptMessage:v,connect:async()=>{var a;u.value=!0,d.value=null;try{const t=await N(),l=await t.wallet.getAddress();if(!l)throw new Error("wallet returned empty address");e.value=l,c.value=!0;const n=null==(a=t.getConfig)?void 0:a.call(t);o.value=(null==n?void 0:n.chainId)??null,s.value=(null==n?void 0:n.chainType)??null,y(n)}catch(t){d.value=t}finally{u.value=!1}},invokeIntent:async e=>{var a;const t=V();if(!(null==(a=null==t?void 0:t.wallet)?void 0:a.invokeIntent))throw new Error("invokeIntent not available");return t.wallet.invokeIntent(e)},invokeContract:async e=>{var a;const t=await N(),l=null==(a=t.getConfig)?void 0:a.call(t),n=e.contractAddress||e.scriptHash||e.contractHash,o=e.method||e.operation;if(!n||!o)throw new Error("contract address and method required");return t.invoke("invokeFunction",{contract:n,method:o,args:e.args,chainId:null==l?void 0:l.chainId,chainType:null==l?void 0:l.chainType})},invokeRead:async e=>{var a;const t=await N(),l=null==(a=t.getConfig)?void 0:a.call(t),n=e.contractAddress||e.scriptHash||e.contractHash||(null==l?void 0:l.contractAddress),o=e.method||e.operation;if(!n)throw new Error("contract address not configured");if(!o)throw new Error("method required");return t.invoke("invokeRead",{contract:n,method:o,args:e.args||[],chainId:e.chainId||(null==l?void 0:l.chainId),chainType:e.chainType||(null==l?void 0:l.chainType)})},getContractAddress:async()=>{var e,a,t,l,n;const o=await N(),s=null==(e=o.getConfig)?void 0:e.call(o);if(null==s?void 0:s.contractAddress)return s.contractAddress;if((null==s?void 0:s.chainId)&&(null==(t=null==(a=null==s?void 0:s.chainContracts)?void 0:a[s.chainId])?void 0:t.address))return s.chainContracts[s.chainId].address||null;if(o.invoke)try{const e=await o.invoke("getConfig");if(null==e?void 0:e.contractAddress)return e.contractAddress;if((null==e?void 0:e.chainId)&&(null==(n=null==(l=null==e?void 0:e.chainContracts)?void 0:l[e.chainId])?void 0:n.address))return e.chainContracts[e.chainId].address||null}catch{}return null},getAppConfig:h,getAddress:async()=>(await N()).wallet.getAddress(),signMessage:async e=>{var a;const t=await N();if(!(null==(a=t.wallet)?void 0:a.signMessage))throw new Error("signMessage not available");return t.wallet.signMessage(e)},switchChain:m,switchToAppChain:async e=>{const a=await h(),t=(null==a?void 0:a.chainId)||(Array.isArray(null==a?void 0:a.supportedChains)&&a.supportedChains.length>0?a.supportedChains[0]:null)||e||null;if(!t)throw new Error("app chain not configured");await m(t)},getBalance:async e=>{var a;u.value=!0,d.value=null;try{const t=await N(),l=null==(a=t.getConfig)?void 0:a.call(t),s=(null==l?void 0:l.chainId)||o.value,i=s?`?chain_id=${encodeURIComponent(s)}`:"",r=await Y(`/wallet-balance${i}`),c=(null==r?void 0:r.balances)??{};return n.value=c,e?c[e]||"0":c}catch(t){throw d.value=t,t}finally{u.value=!1}},getTransactions:async(e=20)=>{var a;u.value=!0,d.value=null;try{const t=Number.isNaN(e)||e<1?20:Math.min(e,100),l=await N(),n=null==(a=l.getConfig)?void 0:a.call(l),s=(null==n?void 0:n.chainId)||o.value,i=new URLSearchParams({limit:String(t)});s&&i.set("chain_id",s);const r=await Y(`/wallet-transactions?${i.toString()}`);return(null==r?void 0:r.transactions)??[]}catch(t){throw d.value=t,t}finally{u.value=!1}},invoke:async(e,a)=>(await N()).invoke(e,a),requireConnection:(e={})=>{const{showPrompt:a=!0,errorMessage:t}=e;return!!c.value||(a&&(v.value=t||null,p.value=!0),!1)},closeConnectionPrompt:()=>{p.value=!1,v.value=null},clearError:()=>{d.value=null}}}const ae=H(o({__name:"ChainWarning",props:{title:{default:"Wrong Network"},message:{default:"Switch to Neo N3 Mainnet to continue."},buttonText:{default:"Switch Network"},show:{type:Boolean,default:void 0}},emits:["switch","switch-complete","switch-error"],setup(e,{emit:t}){const l=e,o=t,{showWarning:h,switchToAppChain:m}=function(){const{switchToAppChain:e}=ee();return{showWarning:n(()=>!1),switchToAppChain:async()=>{try{await e()}catch(a){throw console.error("[useChainValidation] Failed to switch chain:",a),a}}}}(),w=a(!1),g=n(()=>void 0!==l.show?l.show:h.value),b=async()=>{if(!w.value){w.value=!0,o("switch");try{await m(),o("switch-complete")}catch(e){const a=e instanceof Error?e:new Error(String(e));o("switch-error",a),console.error("[ChainWarning] Failed to switch chain:",a)}finally{w.value=!1}}};return(e,a)=>{const t=d,l=r;return g.value?(s(),i(l,{key:0,class:"chain-warning px-4 mb-4"},{default:c(()=>[u(y(U),{variant:"danger"},{default:c(()=>[u(l,{class:"flex flex-col items-center gap-2 py-1"},{default:c(()=>[u(t,{class:"text-center font-bold text-red-400"},{default:c(()=>[p(v(e.title),1)]),_:1}),e.message?(s(),i(t,{key:0,class:"text-xs text-center opacity-80 text-white"},{default:c(()=>[p(v(e.message),1)]),_:1})):f("",!0),u(y(D),{size:"sm",variant:"secondary",class:"mt-2",loading:w.value,onClick:b},{default:c(()=>[p(v(e.buttonText),1)]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1})):f("",!0)}}}),[["__scopeId","data-v-3dc811c7"]]),te=H(o({__name:"NeoInput",props:{modelValue:{},type:{},label:{},placeholder:{},suffix:{},suffixIcon:{},hint:{},error:{},disabled:{type:Boolean}},emits:["update:modelValue","focus","blur"],setup(e){let a=0;const t="neo-input-"+ ++a;return(e,a)=>{const l=d,n=m,o=w,g=r;return s(),i(g,{class:h(["neo-input",{"neo-input--error":e.error,"neo-input--disabled":e.disabled}])},{default:c(()=>[e.label?(s(),i(l,{key:0,class:"neo-input__label"},{default:c(()=>[p(v(e.label),1)]),_:1})):f("",!0),u(g,{class:"neo-input__wrapper"},{default:c(()=>["textarea"===e.type?(s(),i(n,{key:0,value:e.modelValue,placeholder:e.placeholder,disabled:e.disabled,"aria-describedby":e.error?`${t}-error`:e.hint?`${t}-hint`:void 0,"aria-invalid":!!e.error,class:"neo-input__field neo-input__textarea",onInput:a[0]||(a[0]=a=>e.$emit("update:modelValue",a.target.value)),onFocus:a[1]||(a[1]=a=>e.$emit("focus",a)),onBlur:a[2]||(a[2]=a=>e.$emit("blur",a))},null,8,["value","placeholder","disabled","aria-describedby","aria-invalid"])):(s(),i(o,{key:1,value:e.modelValue,type:e.type,placeholder:e.placeholder,disabled:e.disabled,"aria-describedby":e.error?`${t}-error`:e.hint?`${t}-hint`:void 0,"aria-invalid":!!e.error,class:"neo-input__field",onInput:a[3]||(a[3]=a=>e.$emit("update:modelValue",a.target.value)),onFocus:a[4]||(a[4]=a=>e.$emit("focus",a)),onBlur:a[5]||(a[5]=a=>e.$emit("blur",a))},null,8,["value","type","placeholder","disabled","aria-describedby","aria-invalid"])),e.suffixIcon||e.suffix?(s(),i(g,{key:2,class:"neo-input__suffix"},{default:c(()=>[e.suffixIcon?(s(),i(y(j),{key:0,name:e.suffixIcon,size:18},null,8,["name"])):f("",!0),e.suffix?(s(),i(l,{key:1},{default:c(()=>[p(v(e.suffix),1)]),_:1})):f("",!0)]),_:1})):f("",!0)]),_:1}),e.error?(s(),i(l,{key:1,id:`${t}-error`,class:"neo-input__error",role:"alert"},{default:c(()=>[p(v(e.error),1)]),_:1},8,["id"])):e.hint?(s(),i(l,{key:2,id:`${t}-hint`,class:"neo-input__hint"},{default:c(()=>[p(v(e.hint),1)]),_:1},8,["id"])):f("",!0)]),_:1},8,["class"])}}}),[["__scopeId","data-v-fda1146f"]]),le=H(o({__name:"NeoModal",props:{visible:{type:Boolean},title:{},variant:{},closeable:{type:Boolean}},emits:["close"],setup(e){const t=e,n=a(null);let o=null;return g(()=>t.visible,async e=>{var a,t,l,s;if(e){o="undefined"!=typeof document?document.activeElement:null,await k();null==(l=null==(t=(null==(a=n.value)?void 0:a.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'))||n.value)?void 0:t.focus)||l.call(t)}else o&&(null==(s=o.focus)||s.call(o),o=null)}),l(()=>{o=null}),(e,a)=>{const t=d,l=r;return e.visible?(s(),i(l,{key:0,class:"neo-modal",role:"dialog","aria-modal":"true","aria-label":e.title||"Dialog",onClick:a[3]||(a[3]=_(a=>e.closeable&&e.$emit("close"),["self"])),onKeydown:a[4]||(a[4]=b(a=>e.closeable&&e.$emit("close"),["escape"]))},{default:c(()=>[u(l,{ref_key:"contentRef",ref:n,class:h(["neo-modal__content",`neo-modal--${e.variant}`])},{default:c(()=>[e.title?(s(),i(l,{key:0,class:"neo-modal__header"},{default:c(()=>[u(t,{class:"neo-modal__title"},{default:c(()=>[p(v(e.title),1)]),_:1}),e.closeable?(s(),i(l,{key:0,class:"neo-modal__close",role:"button",tabindex:"0","aria-label":"Close dialog",onClick:a[0]||(a[0]=a=>e.$emit("close")),onKeydown:[a[1]||(a[1]=b(a=>e.$emit("close"),["enter"])),a[2]||(a[2]=b(_(a=>e.$emit("close"),["prevent"]),["space"]))]},{default:c(()=>[u(j,{name:"x",size:20})]),_:1})):f("",!0)]),_:1})):f("",!0),u(l,{class:"neo-modal__body"},{default:c(()=>[C(e.$slots,"default",{},void 0,!0)]),_:3}),e.$slots.footer?(s(),i(l,{key:1,class:"neo-modal__footer"},{default:c(()=>[C(e.$slots,"footer",{},void 0,!0)]),_:3})):f("",!0)]),_:3},8,["class"])]),_:3},8,["aria-label"])):f("",!0)}}}),[["__scopeId","data-v-53191fc6"]]),ne=H(o({__name:"WalletPrompt",props:{visible:{type:Boolean},message:{}},emits:["close","connect"],setup(e,{emit:t}){const{t:l}=W(),n=t,o=a(!1),f=async()=>{o.value=!0,n("connect")};return(e,a)=>{const t=d,n=r;return s(),i(le,{visible:e.visible,title:y(l)("wpTitle"),variant:"warning",closeable:!0,onClose:a[1]||(a[1]=a=>e.$emit("close"))},{footer:c(()=>[u(D,{variant:"ghost",size:"sm",onClick:a[0]||(a[0]=a=>e.$emit("close"))},{default:c(()=>[p(v(y(l)("wpCancel")),1)]),_:1})]),default:c(()=>[u(n,{class:"wallet-prompt"},{default:c(()=>[u(t,{class:"wallet-prompt__desc"},{default:c(()=>[p(v(e.message||y(l)("wpDescription")),1)]),_:1}),u(D,{variant:"primary",size:"lg",class:"wallet-prompt__btn",loading:o.value,onClick:f},{default:c(()=>[u(j,{name:"wallet",size:18}),p(" "+v(y(l)("wpConnect")),1)]),_:1},8,["loading"])]),_:1})]),_:1},8,["visible","title"])}}}),[["__scopeId","data-v-2d7cac53"]]);function oe(e){if(null==e)return null;if("object"==typeof e&&"type"in e){const a=e;switch(a.type){case"ByteArray":case"Buffer":case"InteropInterface":default:return a.value;case"Integer":return"string"==typeof a.value?a.value.startsWith("0x")?BigInt(a.value).toString():parseInt(a.value,10):Number(a.value);case"Array":case"Struct":return Array.isArray(a.value)?a.value.map(oe):a.value;case"Map":if(Array.isArray(a.value)){const e=new Map;for(const t of a.value)Array.isArray(t)&&2===t.length&&e.set(oe(t[0]),oe(t[1]));return Object.fromEntries(e)}return a.value;case"Boolean":return Boolean(a.value);case"String":case"Hash160":case"Hash256":return String(a.value)}}return Array.isArray(e)?e.map(oe):e}function se(e){if(!e)return null;if("object"==typeof e&&null!==e){const a=e;return"stack"in a&&Array.isArray(a.stack)?0===a.stack.length?null:1===a.stack.length?oe(a.stack[0]):a.stack.map(oe):"state"in a?oe(a.state):"txid"in a||"txHash"in a?e:oe(e)}return"string"==typeof e||"number"==typeof e||"boolean"==typeof e?e:oe(e)}const ie=new Set(["neo-n3","neo-n3-mainnet","neo-n3-testnet"]);const re=H(o({__name:"AlbumGrid",props:{t:{type:Function},photos:{},loading:{type:Boolean}},emits:["view","upload"],setup:e=>(e,a)=>{const t=d,l=r,n=$;return s(),i(y(U),{variant:"erobo",class:"gallery-card"},{default:c(()=>[e.loading?(s(),i(l,{key:0,class:"loading-state"},{default:c(()=>[u(t,null,{default:c(()=>[p(v(e.t("loading")),1)]),_:1})]),_:1})):(s(),i(l,{key:1,class:"gallery-grid"},{default:c(()=>[(s(!0),A(I,null,x(e.photos,a=>(s(),i(l,{key:a.id,class:"photo-item",onClick:t=>e.$emit("view",a)},{default:c(()=>[a.encrypted?(s(),i(l,{key:1,class:"photo-locked"},{default:c(()=>[u(t,{class:"lock-label"},{default:c(()=>[p(v(e.t("encrypted")),1)]),_:1})]),_:1})):(s(),i(n,{key:0,src:a.data,mode:"aspectFill",class:"photo-img",alt:e.t("albumPhoto")},null,8,["src","alt"])),a.encrypted?(s(),i(l,{key:2,class:"lock-icon"},{default:c(()=>[p(v(e.t("encrypted")),1)]),_:1})):f("",!0)]),_:2},1032,["onClick"]))),128)),u(l,{class:"photo-item placeholder",onClick:a[0]||(a[0]=a=>e.$emit("upload"))},{default:c(()=>[u(t,{class:"plus-icon"},{default:c(()=>[p("+")]),_:1}),u(t,{class:"add-label"},{default:c(()=>[p(v(e.t("addPhoto")),1)]),_:1})]),_:1})]),_:1})),e.loading||0!==e.photos.length?f("",!0):(s(),i(l,{key:2,class:"empty-state"},{default:c(()=>[u(t,{class:"empty-title"},{default:c(()=>[p(v(e.t("emptyTitle")),1)]),_:1}),u(t,{class:"empty-desc"},{default:c(()=>[p(v(e.t("emptyDesc")),1)]),_:1})]),_:1}))]),_:1})}}),[["__scopeId","data-v-75cf6c2e"]]),ce=H(o({__name:"PhotoUpload",props:{t:{type:Function},visible:{type:Boolean},images:{},maxPhotos:{},maxBytes:{},totalSize:{},encrypted:{type:Boolean},password:{},uploading:{type:Boolean}},emits:["close","remove","choose","confirm","update:encrypted","update:password"],setup(e,{emit:t}){const l=t,n=a(e.password);g(n,e=>{l("update:password",e)});const o=e=>e<1024?`${e}B`:`${(e/1024).toFixed(1)}KB`;return(e,a)=>{const t=$,l=r,h=d,m=T;return s(),i(y(le),{visible:e.visible,title:e.t("uploadPhoto"),closeable:"",onClose:a[5]||(a[5]=a=>e.$emit("close"))},{footer:c(()=>[u(y(D),{variant:"ghost",size:"sm",onClick:a[3]||(a[3]=a=>e.$emit("close"))},{default:c(()=>[p(v(e.t("cancel")),1)]),_:1}),u(y(D),{variant:"primary",size:"sm",disabled:0===e.images.length||e.uploading,loading:e.uploading,onClick:a[4]||(a[4]=a=>e.$emit("confirm"))},{default:c(()=>[p(v(e.uploading?e.t("uploading"):e.t("confirm")),1)]),_:1},8,["disabled","loading"])]),default:c(()=>[u(l,{class:"upload-body"},{default:c(()=>[u(l,{class:"upload-grid"},{default:c(()=>[(s(!0),A(I,null,x(e.images,a=>(s(),i(l,{key:a.id,class:"upload-item"},{default:c(()=>[u(t,{src:a.dataUrl,mode:"aspectFill",class:"upload-img",alt:e.t("uploadPreview")},null,8,["src","alt"]),u(l,{class:"remove-btn",onClick:_(t=>e.$emit("remove",a.id),["stop"])},{default:c(()=>[p("Ã—")]),_:2},1032,["onClick"])]),_:2},1024))),128)),e.images.length<e.maxPhotos?(s(),i(l,{key:0,class:"upload-item upload-placeholder",onClick:a[0]||(a[0]=a=>e.$emit("choose"))},{default:c(()=>[u(h,{class:"upload-plus"},{default:c(()=>[p("+")]),_:1}),u(h,{class:"upload-tip"},{default:c(()=>[p(v(e.t("selectMore")),1)]),_:1})]),_:1})):f("",!0)]),_:1}),u(l,{class:"upload-meta"},{default:c(()=>[u(h,null,{default:c(()=>[p(v(e.t("uploadHint",{count:e.images.length,max:e.maxPhotos})),1)]),_:1}),u(h,{class:"upload-meta__size"},{default:c(()=>[p(v(e.t("sizeHint",{size:o(e.totalSize),max:o(e.maxBytes)})),1)]),_:1})]),_:1}),u(l,{class:"form-group"},{default:c(()=>[u(h,{class:"label"},{default:c(()=>[p(v(e.t("encryptPhoto")),1)]),_:1}),u(m,{checked:e.encrypted,onChange:a[1]||(a[1]=a=>e.$emit("update:encrypted",a.detail.value))},null,8,["checked"])]),_:1}),e.encrypted?(s(),i(l,{key:0,class:"form-group column"},{default:c(()=>[u(y(te),{modelValue:n.value,"onUpdate:modelValue":a[2]||(a[2]=e=>n.value=e),type:"password",placeholder:e.t("enterPassword")},null,8,["modelValue","placeholder"]),u(h,{class:"hint"},{default:c(()=>[p(v(e.t("encryptionNote")),1)]),_:1})]),_:1})):f("",!0)]),_:1})]),_:1},8,["visible","title"])}}}),[["__scopeId","data-v-d67f6527"]]),ue=H(o({__name:"AlbumViewer",props:{t:{type:Function},visible:{type:Boolean},photo:{},showShare:{type:Boolean}},emits:["close","decrypt","share"],setup:(e,{emit:a})=>(e,a)=>{const t=$,l=d,n=r;return s(),i(y(le),{visible:e.visible,title:e.t("photoViewer"),closeable:!0,onClose:a[3]||(a[3]=a=>e.$emit("close"))},{footer:c(()=>[e.showShare?(s(),i(y(D),{key:0,size:"sm",variant:"secondary",onClick:a[1]||(a[1]=a=>e.$emit("share"))},{default:c(()=>[p(v(e.t("share")),1)]),_:1})):f("",!0),u(y(D),{size:"sm",variant:"ghost",onClick:a[2]||(a[2]=a=>e.$emit("close"))},{default:c(()=>[p(v(e.t("close")),1)]),_:1})]),default:c(()=>[u(n,{class:"viewer-body"},{default:c(()=>[e.photo&&!e.photo.encrypted?(s(),i(t,{key:0,src:e.photo.data,mode:"aspectFit",class:"viewer-img",alt:e.t("viewingPhoto")},null,8,["src","alt"])):e.photo?(s(),i(n,{key:1,class:"encrypted-notice"},{default:c(()=>[u(l,{class:"notice-text"},{default:c(()=>[p(v(e.t("encryptedPhotoNotice")),1)]),_:1}),u(y(D),{size:"sm",variant:"primary",onClick:a[0]||(a[0]=a=>e.$emit("decrypt"))},{default:c(()=>[p(v(e.t("decryptToView")),1)]),_:1})]),_:1})):f("",!0)]),_:1})]),_:1},8,["visible","title"])}}),[["__scopeId","data-v-62a5b09d"]]),de=H(o({__name:"DecryptModal",props:{t:{type:Function},visible:{type:Boolean},decrypting:{type:Boolean},preview:{}},emits:["close","decrypt","preview"],setup(e,{emit:t}){const l=e,n=a("");return g(()=>l.visible,e=>{e||(n.value="")}),(e,a)=>{const t=$,l=r;return s(),i(y(le),{visible:e.visible,title:e.t("decryptTitle"),closeable:"",onClose:a[3]||(a[3]=a=>e.$emit("close"))},{default:c(()=>[u(l,{class:"decrypt-body"},{default:c(()=>[u(y(te),{modelValue:n.value,"onUpdate:modelValue":a[0]||(a[0]=e=>n.value=e),type:"password",placeholder:e.t("enterPassword")},null,8,["modelValue","placeholder"]),u(y(D),{variant:"secondary",size:"sm",class:"decrypt-btn",loading:e.decrypting,onClick:a[1]||(a[1]=a=>e.$emit("decrypt",n.value))},{default:c(()=>[p(v(e.decrypting?e.t("decrypting"):e.t("decryptConfirm")),1)]),_:1},8,["loading"]),e.preview?(s(),i(l,{key:0,class:"decrypt-preview"},{default:c(()=>[u(t,{src:e.preview,mode:"aspectFit",class:"decrypt-img",alt:e.t("decryptedPhoto")},null,8,["src","alt"]),u(y(D),{size:"sm",variant:"ghost",onClick:a[2]||(a[2]=a=>e.$emit("preview"))},{default:c(()=>[p(v(e.t("openPreview")),1)]),_:1})]),_:1})):f("",!0)]),_:1})]),_:1},8,["visible","title"])}}}),[["__scopeId","data-v-c8588176"]]),pe=6e4,ve=H(o({__name:"index",setup(e){const{t:l}=G(),{address:o,connect:h,invokeRead:m,invokeContract:w,chainType:b,getContractAddress:_}=q(),{encryptPayload:C,decryptPayload:k}=function(){var e;const t=a("undefined"!=typeof window&&!!(null==(e=window.crypto)?void 0:e.subtle)),l=()=>{if(!t.value)throw new Error("Crypto API not available")},n=e=>{let a="";return e.forEach(e=>{a+=String.fromCharCode(e)}),btoa(a)},o=e=>{const a=atob(e),t=new Uint8Array(a.length);for(let l=0;l<a.length;l+=1)t[l]=a.charCodeAt(l);return t},s=async(e,a)=>{l();const t=new TextEncoder,n=await window.crypto.subtle.importKey("raw",t.encode(e),"PBKDF2",!1,["deriveKey"]);return window.crypto.subtle.deriveKey({name:"PBKDF2",salt:a,iterations:1e5,hash:"SHA-256"},n,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])};return{isAvailable:t,encryptPayload:async(e,a)=>{l();const t=new TextEncoder,o=window.crypto.getRandomValues(new Uint8Array(16)),i=window.crypto.getRandomValues(new Uint8Array(12)),r=await s(a,o),c=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:i},r,t.encode(e));return JSON.stringify({v:1,alg:"AES-GCM",salt:n(o),iv:n(i),data:n(new Uint8Array(c))})},decryptPayload:async(e,a)=>{l();const t=JSON.parse(e);if(!t||1!==t.v||"AES-GCM"!==t.alg)throw new Error("Invalid payload format");const n=o(t.salt||""),i=o(t.iv||""),r=o(t.data||""),c=await s(a,n),u=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:i},c,r);return(new TextDecoder).decode(u)}}}(),A=a("album"),x=n(()=>[{id:"album",icon:"archive",label:l("albumTab")},{id:"docs",icon:"book",label:l("docsTab")}]),I=e=>{"docs"===e?B({url:"/pages/docs/index"}):A.value=e},$=a(null),T=a(!1),z=a([]),F=a(!1),N=a([]),V=a(!1),R=a(""),H=a(!1),j=a(!1),W=a(null),L=a(!1),O=a(null),J=a(!1),Q=a(""),X=a(!1),Y=n(()=>N.value.reduce((e,a)=>e+a.size,0)),Z=()=>X.value=!0,ee=()=>X.value=!1,te=async()=>{try{await h(),X.value=!1}catch{X.value=!1}},le=async()=>{if(!function(e,a){const t=function(e){if("string"==typeof e)return e;const a=null==e?void 0:e.value;return"string"==typeof a?a:""}(e);if(ie.has(t))return!0;let l="";if(!l&&"function"==typeof a){const e=a("wrongChainMessage");l=e&&"wrongChainMessage"!==e?e:a("wrongChain")}l||(l="Wrong network");const n=globalThis.uni;return(null==n?void 0:n.showToast)&&n.showToast({title:l,icon:"none"}),!1}(b,l))throw new Error(l("wrongChain"));if($.value||($.value=await _()),!$.value)throw new Error(l("missingContract"));return $.value},oe=async()=>{if(o.value){T.value=!0;try{const e=await le(),a=await m({contractAddress:e,operation:"getUserPhotoCount",args:[{type:"Hash160",value:o.value}]}),t=Number(se(a)||0);if(!t)return void(z.value=[]);const l=Math.min(t,50),n=se(await m({contractAddress:e,operation:"getUserPhotoIds",args:[{type:"Hash160",value:o.value},{type:"Integer",value:"0"},{type:"Integer",value:String(l)}]})),s=Array.isArray(n)?n.map(e=>String(e)).filter(Boolean):[],i=await Promise.all(s.map(async a=>(e=>{if(!Array.isArray(e)||e.length<5)return null;const[a,t,l,n,o]=e;return a&&n?{id:String(a),data:String(n),encrypted:Boolean(l),createdAt:Number(o||0)}:null})(se(await m({contractAddress:e,operation:"getPhoto",args:[{type:"ByteArray",value:a}]})))));z.value=i.filter(e=>!!e).sort((e,a)=>a.createdAt-e.createdAt)}catch(e){E({title:(null==e?void 0:e.message)||l("loadFailed"),icon:"none"})}finally{T.value=!1}}else z.value=[]},ve=async()=>{o.value?(F.value=!0,N.value=[],V.value=!1,R.value=""):Z()},fe=()=>F.value=!1,ye=()=>{const e=5-N.value.length;e<=0?E({title:l("maxPhotosReached"),icon:"none"}):P({count:e,sizeType:["compressed"],sourceType:["album","camera"],success:async e=>{const a=e.tempFilePaths||[];for(const t of a){const e=await me(t),a=e.length;if(a>45e3){E({title:l("imageTooLarge"),icon:"none"});continue}if(Y.value+a>pe){E({title:l("totalTooLarge"),icon:"none"});break}N.value.push({id:`${Date.now()}-${Math.random().toString(16).slice(2)}`,dataUrl:e,size:a})}}})},he=e=>{N.value=N.value.filter(a=>a.id!==e)},me=e=>new Promise((a,t)=>{S({src:e,success:l=>{const n=we(null==l?void 0:l.type,e);uni.getFileSystemManager().readFile({filePath:e,encoding:"base64",success:e=>a(`data:${n};base64,${e.data}`),fail:t})},fail:t})}),we=(e,a)=>{const t=(e||a.split(".").pop()||"").toLowerCase();return"png"===t?"image/png":"gif"===t?"image/gif":"webp"===t?"image/webp":"image/jpeg"},ge=async()=>{if(!H.value&&0!==N.value.length)if(o.value)if(!V.value||R.value){H.value=!0;try{const e=await le(),a=[];let t=0;for(const n of N.value){const e=V.value?await C(n.dataUrl,R.value):n.dataUrl;if(e.length>45e3)throw new Error(l("encryptedTooLarge"));if(t+=e.length,t>pe)throw new Error(l("totalTooLarge"));a.push(e)}await w({contractAddress:e,operation:"uploadPhotos",args:[{type:"Array",value:a.map(e=>({type:"String",value:e}))},{type:"Array",value:a.map(()=>({type:"Boolean",value:V.value}))}]}),E({title:l("uploadSuccess"),icon:"success"}),fe(),N.value=[],await oe()}catch(e){E({title:(null==e?void 0:e.message)||l("uploadFailed"),icon:"none"})}finally{H.value=!1}}else E({title:l("passwordRequired"),icon:"none"});else Z()},be=e=>{if(e.encrypted)return O.value=e,Q.value="",void(L.value=!0);W.value=e,j.value=!0},_e=()=>{j.value=!1,W.value=null},Ce=()=>{j.value=!1,L.value=!0},ke=()=>{L.value=!1,O.value=null,Q.value=""},Ae=async e=>{if(O.value&&e){J.value=!0;try{const a=await k(O.value.data,e);if(!a.startsWith("data:image"))throw new Error(l("invalidPayload"));Q.value=a}catch(a){E({title:(null==a?void 0:a.message)||l("decryptFailed"),icon:"none"})}finally{J.value=!1}}else E({title:l("passwordRequired"),icon:"none"})},xe=()=>{Q.value&&M({urls:[Q.value]})};return t(()=>{o.value&&oe()}),g(o,()=>oe()),(e,a)=>{const t=d,n=r;return s(),i(y(K),{class:"theme-forever-album",tabs:x.value,"active-tab":A.value,"desktop-breakpoint":1024,"show-top-nav":"",onTabChange:I},{"desktop-sidebar":c(()=>[u(n,{class:"desktop-sidebar"},{default:c(()=>[u(t,{class:"sidebar-title"},{default:c(()=>[p(v(y(l)("overview")),1)]),_:1})]),_:1})]),default:c(()=>[u(n,{class:"album-container"},{default:c(()=>[u(y(ae),{title:y(l)("wrongChain"),message:y(l)("wrongChainMessage"),"button-text":y(l)("switchToNeo")},null,8,["title","message","button-text"]),u(n,{class:"header"},{default:c(()=>[u(t,{class:"title"},{default:c(()=>[p(v(y(l)("title")),1)]),_:1}),u(t,{class:"subtitle"},{default:c(()=>[p(v(y(l)("subtitle")),1)]),_:1})]),_:1}),y(o)?f("",!0):(s(),i(y(U),{key:0,variant:"warning",class:"connect-card"},{default:c(()=>[u(n,{class:"connect-card__content"},{default:c(()=>[u(t,{class:"connect-card__title"},{default:c(()=>[p(v(y(l)("connectPromptTitle")),1)]),_:1}),u(t,{class:"connect-card__desc"},{default:c(()=>[p(v(y(l)("connectPromptDesc")),1)]),_:1}),u(y(D),{size:"sm",variant:"primary",onClick:Z},{default:c(()=>[p(v(y(l)("connectWallet")),1)]),_:1})]),_:1})]),_:1})),u(re,{t:y(l),photos:z.value,loading:T.value,onView:be,onUpload:ve},null,8,["t","photos","loading"]),u(n,{class:"helper-note"},{default:c(()=>[u(t,null,{default:c(()=>[p(v(y(l)("tapToSelect")),1)]),_:1})]),_:1})]),_:1}),u(ce,{t:y(l),visible:F.value,images:N.value,"max-photos":5,"max-bytes":pe,"total-size":Y.value,encrypted:V.value,password:R.value,uploading:H.value,onClose:fe,onRemove:he,onChoose:ye,onConfirm:ge,"onUpdate:encrypted":a[0]||(a[0]=e=>V.value=e),"onUpdate:password":a[1]||(a[1]=e=>R.value=e)},null,8,["t","visible","images","total-size","encrypted","password","uploading"]),u(ue,{t:y(l),visible:j.value,photo:W.value,onClose:_e,onDecrypt:Ce},null,8,["t","visible","photo"]),u(de,{t:y(l),visible:L.value,decrypting:J.value,preview:Q.value,onClose:ke,onDecrypt:Ae,onPreview:xe},null,8,["t","visible","decrypting","preview"]),u(y(ne),{visible:X.value,onClose:ee,onConnect:te},null,8,["visible"])]),_:1},8,["tabs","active-tab"])}}}),[["__scopeId","data-v-fea3f25c"]]);export{ve as default};
