services:
  # =============================================================================
  # MarbleRun Coordinator (Simulation Mode)
  # - Runs without SGX devices or AESM/DCAP mounts.
  # =============================================================================
  coordinator:
    image: ${MARBLERUN_COORDINATOR_IMAGE:-ghcr.io/edgelesssys/marblerun/coordinator:v1.8.0}
    container_name: marblerun-coordinator
    ports:
      - 127.0.0.1:2001:2001
      - 127.0.0.1:4433:4433
    environment:
      - EDG_COORDINATOR_MESH_ADDR=0.0.0.0:2001
      - EDG_COORDINATOR_CLIENT_ADDR=0.0.0.0:4433
      - EDG_COORDINATOR_DNS_NAMES=localhost,coordinator
      - EDG_COORDINATOR_SEAL_DIR=/coordinator/data
      - OE_SIMULATION=${OE_SIMULATION:-1}
    volumes:
      - coordinator-data:/coordinator/data
      - ../manifests:/manifests:ro
    restart: unless-stopped

  # =============================================================================
  # NeoFeeds Service Marble - Simulation Mode
  # =============================================================================
  neofeeds:
    image: service-layer/neofeeds:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile.service
      args:
        SERVICE: neofeeds
        EGO_VERSION: ${EGO_VERSION:-1.8.0}
        EGO_STRICT_SIGNING: 0
    container_name: service-neofeeds
    ports:
      - 127.0.0.1:${NEOFEEDS_PORT:-8083}:${NEOFEEDS_PORT:-8083}
    environment:
      - EDG_MARBLE_COORDINATOR_ADDR=${COORDINATOR_MESH_ADDR:-coordinator:2001}
      - EDG_MARBLE_TYPE=neofeeds
      - EDG_MARBLE_DNS_NAMES=localhost,neofeeds
      - SERVICE_TYPE=neofeeds
      - OE_SIMULATION=${OE_SIMULATION:-1}
      - PORT=${NEOFEEDS_PORT:-8083}
      - MARBLE_ENV=${MARBLE_ENV:-development}
      - METRICS_ENABLED
      - SUPABASE_URL
      - SUPABASE_SERVICE_KEY
      - NEO_RPC_URL
      - NEO_NETWORK_MAGIC
      - ARBITRUM_RPC
      - BINANCE_API_KEY
      - CONTRACT_PRICEFEED_HASH
      # NeoFeeds delegates all on-chain writes to txproxy (single allowlist gate).
      - TXPROXY_URL=${TXPROXY_URL:-https://txproxy:8090}
    depends_on:
      - coordinator
    restart: unless-stopped

  # =============================================================================
  # NeoFlow Service Marble - Simulation Mode
  # =============================================================================
  neoflow:
    image: service-layer/neoflow:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile.service
      args:
        SERVICE: neoflow
        EGO_VERSION: ${EGO_VERSION:-1.8.0}
        EGO_STRICT_SIGNING: 0
    container_name: service-neoflow
    ports:
      - 127.0.0.1:${NEOFLOW_PORT:-8084}:${NEOFLOW_PORT:-8084}
    environment:
      - EDG_MARBLE_COORDINATOR_ADDR=${COORDINATOR_MESH_ADDR:-coordinator:2001}
      - EDG_MARBLE_TYPE=neoflow
      - EDG_MARBLE_DNS_NAMES=localhost,neoflow
      - SERVICE_TYPE=neoflow
      - OE_SIMULATION=${OE_SIMULATION:-1}
      - PORT=${NEOFLOW_PORT:-8084}
      - MARBLE_ENV=${MARBLE_ENV:-development}
      - METRICS_ENABLED
      - NEOFLOW_WEBHOOK_ALLOW_PRIVATE_NETWORKS
      - SUPABASE_URL
      - SUPABASE_SERVICE_KEY
      - NEO_RPC_URL
      - NEO_NETWORK_MAGIC
      - CONTRACT_PRICEFEED_HASH
      - CONTRACT_AUTOMATIONANCHOR_HASH
      - NEOFLOW_SCHEDULER_USER_ID
      # NeoFlow delegates all on-chain writes to txproxy (single allowlist gate).
      - TXPROXY_URL=${TXPROXY_URL:-https://txproxy:8090}
    depends_on:
      - coordinator
    restart: unless-stopped

  # =============================================================================
  # NeoAccounts Service Marble - Simulation Mode
  # =============================================================================
  neoaccounts:
    image: service-layer/neoaccounts:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile.service
      args:
        SERVICE: accountpool
        EGO_VERSION: ${EGO_VERSION:-1.8.0}
        EGO_STRICT_SIGNING: 0
    container_name: service-neoaccounts
    ports:
      - 127.0.0.1:${NEOACCOUNTS_PORT:-8085}:${NEOACCOUNTS_PORT:-8085}
    environment:
      - EDG_MARBLE_COORDINATOR_ADDR=${COORDINATOR_MESH_ADDR:-coordinator:2001}
      - EDG_MARBLE_TYPE=neoaccounts
      - EDG_MARBLE_DNS_NAMES=localhost,neoaccounts,accountpool
      - SERVICE_TYPE=neoaccounts
      - OE_SIMULATION=${OE_SIMULATION:-1}
      - PORT=${NEOACCOUNTS_PORT:-8085}
      - MARBLE_ENV=${MARBLE_ENV:-development}
      - METRICS_ENABLED
      - SUPABASE_URL
      - SUPABASE_SERVICE_KEY
      - NEO_RPC_URL
      - NEO_NETWORK_MAGIC
    depends_on:
      - coordinator
    restart: unless-stopped

  # =============================================================================
  # NeoCompute Service Marble - Simulation Mode
  # =============================================================================
  neocompute:
    image: service-layer/neocompute:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile.service
      args:
        SERVICE: neocompute
        EGO_VERSION: ${EGO_VERSION:-1.8.0}
        EGO_STRICT_SIGNING: 0
    container_name: service-neocompute
    ports:
      - 127.0.0.1:${NEOCOMPUTE_PORT:-8086}:${NEOCOMPUTE_PORT:-8086}
    environment:
      - EDG_MARBLE_COORDINATOR_ADDR=${COORDINATOR_MESH_ADDR:-coordinator:2001}
      - EDG_MARBLE_TYPE=neocompute
      - EDG_MARBLE_DNS_NAMES=localhost,neocompute
      - SERVICE_TYPE=neocompute
      - OE_SIMULATION=${OE_SIMULATION:-1}
      - PORT=${NEOCOMPUTE_PORT:-8086}
      - MARBLE_ENV=${MARBLE_ENV:-development}
      - METRICS_ENABLED
      - SUPABASE_URL
      - SUPABASE_SERVICE_KEY
      - NEO_RPC_URL
      - NEO_NETWORK_MAGIC
      - SECRETS_MASTER_KEY
      - NEOCOMPUTE_RESULT_TTL
    depends_on:
      - coordinator
    restart: unless-stopped

  # =============================================================================
  # NeoOracle Service Marble - Simulation Mode
  # =============================================================================
  neooracle:
    image: service-layer/neooracle:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile.service
      args:
        SERVICE: neooracle
        EGO_VERSION: ${EGO_VERSION:-1.8.0}
        EGO_STRICT_SIGNING: 0
    container_name: service-neooracle
    ports:
      - 127.0.0.1:${NEOORACLE_PORT:-8088}:${NEOORACLE_PORT:-8088}
    environment:
      - EDG_MARBLE_COORDINATOR_ADDR=${COORDINATOR_MESH_ADDR:-coordinator:2001}
      - EDG_MARBLE_TYPE=neooracle
      - EDG_MARBLE_DNS_NAMES=localhost,neooracle,oracle
      - SERVICE_TYPE=neooracle
      - OE_SIMULATION=${OE_SIMULATION:-1}
      - PORT=${NEOORACLE_PORT:-8088}
      - MARBLE_ENV=${MARBLE_ENV:-development}
      - METRICS_ENABLED
      - SUPABASE_URL
      - SUPABASE_SERVICE_KEY
      - NEO_RPC_URL
      - NEO_NETWORK_MAGIC
      - SECRETS_MASTER_KEY
      - ORACLE_HTTP_ALLOWLIST
      - ORACLE_TIMEOUT
      - ORACLE_MAX_SIZE
    depends_on:
      - coordinator
    restart: unless-stopped

  # =============================================================================
  # TxProxy Service Marble - Simulation Mode
  # =============================================================================
  txproxy:
    image: service-layer/txproxy:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile.service
      args:
        SERVICE: txproxy
        EGO_VERSION: ${EGO_VERSION:-1.8.0}
        EGO_STRICT_SIGNING: 0
    container_name: service-txproxy
    ports:
      - 127.0.0.1:${TXPROXY_PORT:-8090}:${TXPROXY_PORT:-8090}
    environment:
      - EDG_MARBLE_COORDINATOR_ADDR=${COORDINATOR_MESH_ADDR:-coordinator:2001}
      - EDG_MARBLE_TYPE=txproxy
      - EDG_MARBLE_DNS_NAMES=localhost,txproxy
      - SERVICE_TYPE=txproxy
      - OE_SIMULATION=${OE_SIMULATION:-1}
      - PORT=${TXPROXY_PORT:-8090}
      - MARBLE_ENV=${MARBLE_ENV:-development}
      - METRICS_ENABLED
      - SUPABASE_URL
      - SUPABASE_SERVICE_KEY
      - NEO_RPC_URL
      - NEO_NETWORK_MAGIC
      - CONTRACT_PAYMENTHUB_HASH
      - CONTRACT_GOVERNANCE_HASH
      - TXPROXY_ALLOWLIST
      - GLOBALSIGNER_SERVICE_URL=${GLOBALSIGNER_SERVICE_URL:-https://globalsigner:8092}
    depends_on:
      - coordinator
    restart: unless-stopped

  # =============================================================================
  # GlobalSigner Service Marble - Simulation Mode
  # Central signing authority (domain-separated signing + key rotation).
  # =============================================================================
  globalsigner:
    image: service-layer/globalsigner:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile.service
      args:
        SERVICE: globalsigner
        EGO_VERSION: ${EGO_VERSION:-1.8.0}
        EGO_STRICT_SIGNING: 0
    container_name: service-globalsigner
    ports:
      - 127.0.0.1:${GLOBALSIGNER_PORT:-8092}:${GLOBALSIGNER_PORT:-8092}
    environment:
      - EDG_MARBLE_COORDINATOR_ADDR=${COORDINATOR_MESH_ADDR:-coordinator:2001}
      - EDG_MARBLE_TYPE=globalsigner
      - EDG_MARBLE_DNS_NAMES=localhost,globalsigner
      - SERVICE_TYPE=globalsigner
      - OE_SIMULATION=${OE_SIMULATION:-1}
      - PORT=${GLOBALSIGNER_PORT:-8092}
      - MARBLE_ENV=${MARBLE_ENV:-development}
      - METRICS_ENABLED
      - SUPABASE_URL
      - SUPABASE_SERVICE_KEY
      - GLOBALSIGNER_MASTER_SEED
    depends_on:
      - coordinator
    restart: unless-stopped

volumes:
  coordinator-data:
