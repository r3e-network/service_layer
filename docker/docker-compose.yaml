version: '3.8'

services:
  # =============================================================================
  # MarbleRun Coordinator
  # =============================================================================
  coordinator:
    image: ghcr.io/edgelesssys/marblerun/coordinator:v1.7.0
    container_name: marblerun-coordinator
    ports:
      - "4433:4433"   # Client API
      - "9944:9944"   # Mesh API
    environment:
      - EDG_COORDINATOR_MESH_ADDR=coordinator:2001
      - EDG_COORDINATOR_CLIENT_ADDR=coordinator:4433
      - EDG_COORDINATOR_DNS_NAMES=localhost,coordinator
      - EDG_COORDINATOR_SEAL_DIR=/coordinator/data
      - OE_SIMULATION=${OE_SIMULATION:-1}
    volumes:
      - coordinator-data:/coordinator/data
      - ./manifests:/manifests:ro
    networks:
      - marblerun
    restart: unless-stopped

  # =============================================================================
  # Gateway Marble (API Gateway)
  # =============================================================================
  gateway:
    build:
      context: ..
      dockerfile: docker/Dockerfile.gateway
    container_name: service-gateway
    ports:
      - "8080:8080"
    environment:
      - EDG_MARBLE_COORDINATOR_ADDR=coordinator:2001
      - EDG_MARBLE_TYPE=gateway
      - EDG_MARBLE_DNS_NAMES=localhost,gateway
      - EDG_MARBLE_UUID_FILE=/marble/uuid
      - OE_SIMULATION=${OE_SIMULATION:-1}
      - PORT=8080
    volumes:
      - gateway-data:/marble
    depends_on:
      - coordinator
    networks:
      - marblerun
    restart: unless-stopped

  # =============================================================================
  # VRF Service Marble
  # =============================================================================
  vrf:
    build:
      context: ..
      dockerfile: docker/Dockerfile.service
      args:
        SERVICE: vrf
    container_name: service-vrf
    environment:
      - EDG_MARBLE_COORDINATOR_ADDR=coordinator:2001
      - EDG_MARBLE_TYPE=vrf
      - EDG_MARBLE_DNS_NAMES=localhost,vrf
      - SERVICE_TYPE=vrf
      - OE_SIMULATION=${OE_SIMULATION:-1}
    depends_on:
      - coordinator
    networks:
      - marblerun
    restart: unless-stopped

  # =============================================================================
  # Mixer Service Marble
  # =============================================================================
  mixer:
    build:
      context: ..
      dockerfile: docker/Dockerfile.service
      args:
        SERVICE: mixer
    container_name: service-mixer
    environment:
      - EDG_MARBLE_COORDINATOR_ADDR=coordinator:2001
      - EDG_MARBLE_TYPE=mixer
      - EDG_MARBLE_DNS_NAMES=localhost,mixer
      - SERVICE_TYPE=mixer
      - OE_SIMULATION=${OE_SIMULATION:-1}
    depends_on:
      - coordinator
      - accountpool
    networks:
      - marblerun
    restart: unless-stopped

  # =============================================================================
  # DataFeeds Service Marble
  # =============================================================================
  datafeeds:
    build:
      context: ..
      dockerfile: docker/Dockerfile.service
      args:
        SERVICE: datafeeds
    container_name: service-datafeeds
    environment:
      - EDG_MARBLE_COORDINATOR_ADDR=coordinator:2001
      - EDG_MARBLE_TYPE=datafeeds
      - EDG_MARBLE_DNS_NAMES=localhost,datafeeds
      - SERVICE_TYPE=datafeeds
      - OE_SIMULATION=${OE_SIMULATION:-1}
    depends_on:
      - coordinator
    networks:
      - marblerun
    restart: unless-stopped

  # =============================================================================
  # Automation Service Marble
  # =============================================================================
  automation:
    build:
      context: ..
      dockerfile: docker/Dockerfile.service
      args:
        SERVICE: automation
    container_name: service-automation
    environment:
      - EDG_MARBLE_COORDINATOR_ADDR=coordinator:2001
      - EDG_MARBLE_TYPE=automation
      - EDG_MARBLE_DNS_NAMES=localhost,automation
      - SERVICE_TYPE=automation
      - OE_SIMULATION=${OE_SIMULATION:-1}
    depends_on:
      - coordinator
    networks:
      - marblerun
    restart: unless-stopped

  # =============================================================================
  # AccountPool Service Marble (Internal - Shared Account Management)
  # Not exposed externally, used by other services (mixer, etc.)
  # =============================================================================
  accountpool:
    build:
      context: ..
      dockerfile: docker/Dockerfile.service
      args:
        SERVICE: accountpool
    container_name: service-accountpool
    environment:
      - EDG_MARBLE_COORDINATOR_ADDR=coordinator:2001
      - EDG_MARBLE_TYPE=accountpool
      - EDG_MARBLE_DNS_NAMES=localhost,accountpool
      - SERVICE_TYPE=accountpool
      - OE_SIMULATION=${OE_SIMULATION:-1}
    depends_on:
      - coordinator
    networks:
      - marblerun
    restart: unless-stopped

  # =============================================================================
  # Confidential Compute Service Marble (Planned)
  # =============================================================================
  confidential:
    build:
      context: ..
      dockerfile: docker/Dockerfile.service
      args:
        SERVICE: confidential
    container_name: service-confidential
    environment:
      - EDG_MARBLE_COORDINATOR_ADDR=coordinator:2001
      - EDG_MARBLE_TYPE=confidential
      - EDG_MARBLE_DNS_NAMES=localhost,confidential
      - SERVICE_TYPE=confidential
      - OE_SIMULATION=${OE_SIMULATION:-1}
    depends_on:
      - coordinator
    networks:
      - marblerun
    restart: unless-stopped

networks:
  marblerun:
    driver: bridge

volumes:
  coordinator-data:
  gateway-data:
