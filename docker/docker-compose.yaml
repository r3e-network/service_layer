services:
  # =============================================================================
  # MarbleRun Coordinator
  # =============================================================================
  coordinator:
    image: ${MARBLERUN_COORDINATOR_IMAGE:-ghcr.io/edgelesssys/marblerun/coordinator:v1.8.0}
    container_name: marblerun-coordinator
    ports:
      - 127.0.0.1:2001:2001
      - 127.0.0.1:4433:4433
    environment:
      - EDG_COORDINATOR_MESH_ADDR=0.0.0.0:2001
      - EDG_COORDINATOR_CLIENT_ADDR=0.0.0.0:4433
      - EDG_COORDINATOR_DNS_NAMES=localhost,coordinator
      - EDG_COORDINATOR_SEAL_DIR=/coordinator/data
      - OE_SIMULATION=${OE_SIMULATION:-0}
    volumes:
      - coordinator-data:/coordinator/data
      - ../manifests:/manifests:ro
      - /var/run/aesmd:/var/run/aesmd
      - /etc/sgx_default_qcnl.conf:/etc/sgx_default_qcnl.conf:ro
    devices:
      - /dev/sgx_enclave:/dev/sgx_enclave
      - /dev/sgx_provision:/dev/sgx_provision
    restart: unless-stopped

  # =============================================================================
  # NeoFeeds Service Marble
  # =============================================================================
  neofeeds:
    image: service-layer/neofeeds:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile.service
      args:
        SERVICE: neofeeds
        EGO_VERSION: ${EGO_VERSION:-1.8.0}
        EGO_STRICT_SIGNING: ${EGO_STRICT_SIGNING:-1}
    container_name: service-neofeeds
    environment:
      - EDG_MARBLE_COORDINATOR_ADDR=${COORDINATOR_MESH_ADDR:-coordinator:2001}
      - EDG_MARBLE_TYPE=neofeeds
      - EDG_MARBLE_DNS_NAMES=localhost,neofeeds
      - SERVICE_TYPE=neofeeds
      - OE_SIMULATION=${OE_SIMULATION:-0}
      - MARBLE_ENV=${MARBLE_ENV:-production}
      - SUPABASE_URL
      - SUPABASE_SERVICE_KEY
      - NEO_RPC_URL
      - NEO_NETWORK_MAGIC
      - ARBITRUM_RPC
      - BINANCE_API_KEY
      - CONTRACT_PRICEFEED_HASH
      - TEE_PRIVATE_KEY
      - GLOBALSIGNER_SERVICE_URL=${GLOBALSIGNER_SERVICE_URL:-http://globalsigner:8092}
    volumes:
      - /var/run/aesmd:/var/run/aesmd
      - /etc/sgx_default_qcnl.conf:/etc/sgx_default_qcnl.conf:ro
    devices:
      - /dev/sgx_enclave:/dev/sgx_enclave
      - /dev/sgx_provision:/dev/sgx_provision
    depends_on:
      - coordinator
    restart: unless-stopped

  # =============================================================================
  # NeoFlow Service Marble
  # =============================================================================
  neoflow:
    image: service-layer/neoflow:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile.service
      args:
        SERVICE: neoflow
        EGO_VERSION: ${EGO_VERSION:-1.8.0}
        EGO_STRICT_SIGNING: ${EGO_STRICT_SIGNING:-1}
    container_name: service-neoflow
    environment:
      - EDG_MARBLE_COORDINATOR_ADDR=${COORDINATOR_MESH_ADDR:-coordinator:2001}
      - EDG_MARBLE_TYPE=neoflow
      - EDG_MARBLE_DNS_NAMES=localhost,neoflow
      - SERVICE_TYPE=neoflow
      - OE_SIMULATION=${OE_SIMULATION:-0}
      - MARBLE_ENV=${MARBLE_ENV:-production}
      - NEOFLOW_WEBHOOK_ALLOW_PRIVATE_NETWORKS
      - SUPABASE_URL
      - SUPABASE_SERVICE_KEY
      - NEO_RPC_URL
      - NEO_NETWORK_MAGIC
      - CONTRACT_PRICEFEED_HASH
      - CONTRACT_AUTOMATIONANCHOR_HASH
      - NEOFLOW_SCHEDULER_USER_ID
      - TEE_PRIVATE_KEY
      - GLOBALSIGNER_SERVICE_URL=${GLOBALSIGNER_SERVICE_URL:-http://globalsigner:8092}
    volumes:
      - /var/run/aesmd:/var/run/aesmd
      - /etc/sgx_default_qcnl.conf:/etc/sgx_default_qcnl.conf:ro
    devices:
      - /dev/sgx_enclave:/dev/sgx_enclave
      - /dev/sgx_provision:/dev/sgx_provision
    depends_on:
      - coordinator
    restart: unless-stopped

  # =============================================================================
  # AccountPool Service Marble (Internal)
  # =============================================================================
  neoaccounts:
    image: service-layer/neoaccounts:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile.service
      args:
        SERVICE: accountpool
        EGO_VERSION: ${EGO_VERSION:-1.8.0}
        EGO_STRICT_SIGNING: ${EGO_STRICT_SIGNING:-1}
    container_name: service-accountpool
    environment:
      - EDG_MARBLE_COORDINATOR_ADDR=${COORDINATOR_MESH_ADDR:-coordinator:2001}
      - EDG_MARBLE_TYPE=neoaccounts
      - EDG_MARBLE_DNS_NAMES=localhost,neoaccounts,accountpool
      - SERVICE_TYPE=neoaccounts
      - OE_SIMULATION=${OE_SIMULATION:-0}
      - MARBLE_ENV=${MARBLE_ENV:-production}
      - SUPABASE_URL
      - SUPABASE_SERVICE_KEY
      - NEO_RPC_URL
      - NEO_NETWORK_MAGIC
      - GLOBALSIGNER_SERVICE_URL=${GLOBALSIGNER_SERVICE_URL:-http://globalsigner:8092}
    volumes:
      - /var/run/aesmd:/var/run/aesmd
      - /etc/sgx_default_qcnl.conf:/etc/sgx_default_qcnl.conf:ro
    devices:
      - /dev/sgx_enclave:/dev/sgx_enclave
      - /dev/sgx_provision:/dev/sgx_provision
    depends_on:
      - coordinator
    restart: unless-stopped

  # =============================================================================
  # NeoCompute Service Marble
  # =============================================================================
  neocompute:
    image: service-layer/neocompute:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile.service
      args:
        SERVICE: neocompute
        EGO_VERSION: ${EGO_VERSION:-1.8.0}
        EGO_STRICT_SIGNING: ${EGO_STRICT_SIGNING:-1}
    container_name: service-neocompute
    environment:
      - EDG_MARBLE_COORDINATOR_ADDR=${COORDINATOR_MESH_ADDR:-coordinator:2001}
      - EDG_MARBLE_TYPE=neocompute
      - EDG_MARBLE_DNS_NAMES=localhost,neocompute
      - SERVICE_TYPE=neocompute
      - OE_SIMULATION=${OE_SIMULATION:-0}
      - MARBLE_ENV=${MARBLE_ENV:-production}
      - SUPABASE_URL
      - SUPABASE_SERVICE_KEY
      - NEO_RPC_URL
      - NEO_NETWORK_MAGIC
      - SECRETS_MASTER_KEY
      - TEE_PRIVATE_KEY
      - NEOCOMPUTE_RESULT_TTL
      - GLOBALSIGNER_SERVICE_URL=${GLOBALSIGNER_SERVICE_URL:-http://globalsigner:8092}
    volumes:
      - /var/run/aesmd:/var/run/aesmd
      - /etc/sgx_default_qcnl.conf:/etc/sgx_default_qcnl.conf:ro
    devices:
      - /dev/sgx_enclave:/dev/sgx_enclave
      - /dev/sgx_provision:/dev/sgx_provision
    depends_on:
      - coordinator
    restart: unless-stopped

  # =============================================================================
  # NeoOracle Service Marble
  # =============================================================================
  neooracle:
    image: service-layer/neooracle:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile.service
      args:
        SERVICE: neooracle
        EGO_VERSION: ${EGO_VERSION:-1.8.0}
        EGO_STRICT_SIGNING: ${EGO_STRICT_SIGNING:-1}
    container_name: service-neooracle
    environment:
      - EDG_MARBLE_COORDINATOR_ADDR=${COORDINATOR_MESH_ADDR:-coordinator:2001}
      - EDG_MARBLE_TYPE=neooracle
      - EDG_MARBLE_DNS_NAMES=localhost,neooracle,oracle
      - SERVICE_TYPE=neooracle
      - OE_SIMULATION=${OE_SIMULATION:-0}
      - MARBLE_ENV=${MARBLE_ENV:-production}
      - SUPABASE_URL
      - SUPABASE_SERVICE_KEY
      - NEO_RPC_URL
      - NEO_NETWORK_MAGIC
      - SECRETS_MASTER_KEY
      - ORACLE_HTTP_ALLOWLIST
      - ORACLE_TIMEOUT
      - ORACLE_MAX_SIZE
      - TEE_PRIVATE_KEY
      - GLOBALSIGNER_SERVICE_URL=${GLOBALSIGNER_SERVICE_URL:-http://globalsigner:8092}
    volumes:
      - /var/run/aesmd:/var/run/aesmd
      - /etc/sgx_default_qcnl.conf:/etc/sgx_default_qcnl.conf:ro
    devices:
      - /dev/sgx_enclave:/dev/sgx_enclave
      - /dev/sgx_provision:/dev/sgx_provision
    depends_on:
      - coordinator
    restart: unless-stopped

  # =============================================================================
  # TxProxy Service Marble
  # =============================================================================
  txproxy:
    image: service-layer/txproxy:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile.service
      args:
        SERVICE: txproxy
        EGO_VERSION: ${EGO_VERSION:-1.8.0}
        EGO_STRICT_SIGNING: ${EGO_STRICT_SIGNING:-1}
    container_name: service-txproxy
    environment:
      - EDG_MARBLE_COORDINATOR_ADDR=${COORDINATOR_MESH_ADDR:-coordinator:2001}
      - EDG_MARBLE_TYPE=txproxy
      - EDG_MARBLE_DNS_NAMES=localhost,txproxy
      - SERVICE_TYPE=txproxy
      - OE_SIMULATION=${OE_SIMULATION:-0}
      - MARBLE_ENV=${MARBLE_ENV:-production}
      - SUPABASE_URL
      - SUPABASE_SERVICE_KEY
      - NEO_RPC_URL
      - NEO_NETWORK_MAGIC
      - CONTRACT_PAYMENTHUB_HASH
      - CONTRACT_GOVERNANCE_HASH
      - TXPROXY_ALLOWLIST
      - GLOBALSIGNER_SERVICE_URL=${GLOBALSIGNER_SERVICE_URL:-http://globalsigner:8092}
    volumes:
      - /var/run/aesmd:/var/run/aesmd
      - /etc/sgx_default_qcnl.conf:/etc/sgx_default_qcnl.conf:ro
    devices:
      - /dev/sgx_enclave:/dev/sgx_enclave
      - /dev/sgx_provision:/dev/sgx_provision
    depends_on:
      - coordinator
    restart: unless-stopped

  # =============================================================================
  # GlobalSigner Service Marble
  # =============================================================================
  globalsigner:
    image: service-layer/globalsigner:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile.service
      args:
        SERVICE: globalsigner
        EGO_VERSION: ${EGO_VERSION:-1.8.0}
        EGO_STRICT_SIGNING: ${EGO_STRICT_SIGNING:-1}
    container_name: service-globalsigner
    environment:
      - EDG_MARBLE_COORDINATOR_ADDR=${COORDINATOR_MESH_ADDR:-coordinator:2001}
      - EDG_MARBLE_TYPE=globalsigner
      - EDG_MARBLE_DNS_NAMES=localhost,globalsigner
      - SERVICE_TYPE=globalsigner
      - OE_SIMULATION=${OE_SIMULATION:-0}
      - PORT=${GLOBALSIGNER_PORT:-8092}
      - MARBLE_ENV=${MARBLE_ENV:-production}
      - SUPABASE_URL
      - SUPABASE_SERVICE_KEY
      - GLOBALSIGNER_MASTER_SEED
    volumes:
      - /var/run/aesmd:/var/run/aesmd
      - /etc/sgx_default_qcnl.conf:/etc/sgx_default_qcnl.conf:ro
    devices:
      - /dev/sgx_enclave:/dev/sgx_enclave
      - /dev/sgx_provision:/dev/sgx_provision
    depends_on:
      - coordinator
    restart: unless-stopped

volumes:
  coordinator-data:
