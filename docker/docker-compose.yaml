services:
  # =============================================================================
  # MarbleRun Coordinator
  # =============================================================================
  coordinator:
    image: ${MARBLERUN_COORDINATOR_IMAGE:-ghcr.io/edgelesssys/marblerun/coordinator:v1.8.0}
    container_name: marblerun-coordinator
    ports:
      - 127.0.0.1:2001:2001
      - 127.0.0.1:4433:4433
    environment:
      - EDG_COORDINATOR_MESH_ADDR=0.0.0.0:2001
      - EDG_COORDINATOR_CLIENT_ADDR=0.0.0.0:4433
      - EDG_COORDINATOR_DNS_NAMES=localhost,coordinator
      - EDG_COORDINATOR_SEAL_DIR=/coordinator/data
      - OE_SIMULATION=${OE_SIMULATION:-0}
    volumes:
      - coordinator-data:/coordinator/data
      - ../manifests:/manifests:ro
      - /var/run/aesmd:/var/run/aesmd
      - /etc/sgx_default_qcnl.conf:/etc/sgx_default_qcnl.conf:ro
    devices:
      - /dev/sgx_enclave:/dev/sgx_enclave
      - /dev/sgx_provision:/dev/sgx_provision
    restart: unless-stopped

  # =============================================================================
  # NeoFeeds Service Marble
  # =============================================================================
  neofeeds:
    image: service-layer/neofeeds:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile.service
      args:
        SERVICE: neofeeds
        EGO_VERSION: ${EGO_VERSION:-1.8.0}
        EGO_STRICT_SIGNING: ${EGO_STRICT_SIGNING:-1}
    container_name: service-neofeeds
    environment:
      - EDG_MARBLE_COORDINATOR_ADDR=${COORDINATOR_MESH_ADDR:-coordinator:2001}
      - EDG_MARBLE_TYPE=neofeeds
      - EDG_MARBLE_DNS_NAMES=localhost,neofeeds
      - SERVICE_TYPE=neofeeds
      - OE_SIMULATION=${OE_SIMULATION:-0}
      - MARBLE_ENV=${MARBLE_ENV:-production}
      - SUPABASE_URL
      - SUPABASE_SERVICE_KEY
      - NEO_RPC_URL
      - NEO_NETWORK_MAGIC
      - POOL_MASTER_KEY
      - COORD_MASTER_SEED
      - NEOACCOUNTS_ALLOW_EPHEMERAL_MASTER_KEY
      - NEOACCOUNTS_DELETE_RETIRING_ACCOUNTS
      - ARBITRUM_RPC
      - BINANCE_API_KEY
      - CONTRACT_PRICEFEED_HASH
      - GASBANK_URL=${GASBANK_URL:-https://neogasbank:8091}
      # NeoFeeds delegates all on-chain writes to txproxy (single allowlist gate).
      - TXPROXY_URL=${TXPROXY_URL:-https://txproxy:8090}
      - TXPROXY_TIMEOUT=${TXPROXY_TIMEOUT:-90s}
    volumes:
      - /var/run/aesmd:/var/run/aesmd
      - /etc/sgx_default_qcnl.conf:/etc/sgx_default_qcnl.conf:ro
    devices:
      - /dev/sgx_enclave:/dev/sgx_enclave
      - /dev/sgx_provision:/dev/sgx_provision
    depends_on:
      - coordinator
    restart: unless-stopped

  # =============================================================================
  # NeoFlow Service Marble
  # =============================================================================
  neoflow:
    image: service-layer/neoflow:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile.service
      args:
        SERVICE: neoflow
        EGO_VERSION: ${EGO_VERSION:-1.8.0}
        EGO_STRICT_SIGNING: ${EGO_STRICT_SIGNING:-1}
    container_name: service-neoflow
    environment:
      - EDG_MARBLE_COORDINATOR_ADDR=${COORDINATOR_MESH_ADDR:-coordinator:2001}
      - EDG_MARBLE_TYPE=neoflow
      - EDG_MARBLE_DNS_NAMES=localhost,neoflow
      - SERVICE_TYPE=neoflow
      - OE_SIMULATION=${OE_SIMULATION:-0}
      - MARBLE_ENV=${MARBLE_ENV:-production}
      - NEOFLOW_WEBHOOK_ALLOW_PRIVATE_NETWORKS
      - SUPABASE_URL
      - SUPABASE_SERVICE_KEY
      - NEO_RPC_URL
      - NEO_NETWORK_MAGIC
      - CONTRACT_PRICEFEED_HASH
      - CONTRACT_AUTOMATIONANCHOR_HASH
      - NEOFLOW_SCHEDULER_USER_ID
      - GASBANK_URL=${GASBANK_URL:-https://neogasbank:8091}
      # NeoFlow delegates all on-chain writes to txproxy (single allowlist gate).
      - TXPROXY_URL=${TXPROXY_URL:-https://txproxy:8090}
      - TXPROXY_TIMEOUT=${TXPROXY_TIMEOUT:-90s}
    volumes:
      - /var/run/aesmd:/var/run/aesmd
      - /etc/sgx_default_qcnl.conf:/etc/sgx_default_qcnl.conf:ro
    devices:
      - /dev/sgx_enclave:/dev/sgx_enclave
      - /dev/sgx_provision:/dev/sgx_provision
    depends_on:
      - coordinator
    restart: unless-stopped

  # =============================================================================
  # AccountPool Service Marble (Internal)
  # =============================================================================
  neoaccounts:
    image: service-layer/neoaccounts:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile.service
      args:
        SERVICE: accountpool
        EGO_VERSION: ${EGO_VERSION:-1.8.0}
        EGO_STRICT_SIGNING: ${EGO_STRICT_SIGNING:-1}
    container_name: service-accountpool
    environment:
      - EDG_MARBLE_COORDINATOR_ADDR=${COORDINATOR_MESH_ADDR:-coordinator:2001}
      - EDG_MARBLE_TYPE=neoaccounts
      - EDG_MARBLE_DNS_NAMES=localhost,neoaccounts,accountpool
      - SERVICE_TYPE=neoaccounts
      - OE_SIMULATION=${OE_SIMULATION:-0}
      - MARBLE_ENV=${MARBLE_ENV:-production}
      - SUPABASE_URL
      - SUPABASE_SERVICE_KEY
      - NEO_RPC_URL
      - NEO_NETWORK_MAGIC
      - POOL_ENCRYPTION_KEY
    volumes:
      - /var/run/aesmd:/var/run/aesmd
      - /etc/sgx_default_qcnl.conf:/etc/sgx_default_qcnl.conf:ro
    devices:
      - /dev/sgx_enclave:/dev/sgx_enclave
      - /dev/sgx_provision:/dev/sgx_provision
    depends_on:
      - coordinator
    restart: unless-stopped

  # =============================================================================
  # NeoGasBank Service Marble
  # =============================================================================
  neogasbank:
    image: service-layer/neogasbank:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile.service
      args:
        SERVICE: neogasbank
        EGO_VERSION: ${EGO_VERSION:-1.8.0}
        EGO_STRICT_SIGNING: ${EGO_STRICT_SIGNING:-1}
    container_name: service-neogasbank
    environment:
      - EDG_MARBLE_COORDINATOR_ADDR=${COORDINATOR_MESH_ADDR:-coordinator:2001}
      - EDG_MARBLE_TYPE=neogasbank
      - EDG_MARBLE_DNS_NAMES=localhost,neogasbank
      - SERVICE_TYPE=neogasbank
      - OE_SIMULATION=${OE_SIMULATION:-0}
      - MARBLE_ENV=${MARBLE_ENV:-production}
      - SUPABASE_URL
      - SUPABASE_SERVICE_KEY
      - NEO_RPC_URL
      - NEO_NETWORK_MAGIC
      - GASBANK_DEPOSIT_ADDRESS
      - NEOACCOUNTS_SERVICE_URL=https://neoaccounts:8085
      - TOPUP_ENABLED
    volumes:
      - /var/run/aesmd:/var/run/aesmd
      - /etc/sgx_default_qcnl.conf:/etc/sgx_default_qcnl.conf:ro
    devices:
      - /dev/sgx_enclave:/dev/sgx_enclave
      - /dev/sgx_provision:/dev/sgx_provision
    depends_on:
      - coordinator
      - neoaccounts
    restart: unless-stopped

  # =============================================================================
  # NeoCompute Service Marble
  # =============================================================================
  neocompute:
    image: service-layer/neocompute:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile.service
      args:
        SERVICE: neocompute
        EGO_VERSION: ${EGO_VERSION:-1.8.0}
        EGO_STRICT_SIGNING: ${EGO_STRICT_SIGNING:-1}
    container_name: service-neocompute
    environment:
      - EDG_MARBLE_COORDINATOR_ADDR=${COORDINATOR_MESH_ADDR:-coordinator:2001}
      - EDG_MARBLE_TYPE=neocompute
      - EDG_MARBLE_DNS_NAMES=localhost,neocompute
      - SERVICE_TYPE=neocompute
      - OE_SIMULATION=${OE_SIMULATION:-0}
      - MARBLE_ENV=${MARBLE_ENV:-production}
      - SUPABASE_URL
      - SUPABASE_SERVICE_KEY
      - NEO_RPC_URL
      - NEO_NETWORK_MAGIC
      - SECRETS_MASTER_KEY
      - NEOCOMPUTE_RESULT_TTL
    volumes:
      - /var/run/aesmd:/var/run/aesmd
      - /etc/sgx_default_qcnl.conf:/etc/sgx_default_qcnl.conf:ro
    devices:
      - /dev/sgx_enclave:/dev/sgx_enclave
      - /dev/sgx_provision:/dev/sgx_provision
    depends_on:
      - coordinator
    restart: unless-stopped

  # =============================================================================
  # NeoVRF Service Marble
  # =============================================================================
  neovrf:
    image: service-layer/neovrf:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile.service
      args:
        SERVICE: neovrf
        EGO_VERSION: ${EGO_VERSION:-1.8.0}
        EGO_STRICT_SIGNING: ${EGO_STRICT_SIGNING:-1}
    container_name: service-neovrf
    environment:
      - EDG_MARBLE_COORDINATOR_ADDR=${COORDINATOR_MESH_ADDR:-coordinator:2001}
      - EDG_MARBLE_TYPE=neovrf
      - EDG_MARBLE_DNS_NAMES=localhost,neovrf,vrf
      - SERVICE_TYPE=neovrf
      - OE_SIMULATION=${OE_SIMULATION:-0}
      - MARBLE_ENV=${MARBLE_ENV:-production}
      - SUPABASE_URL
      - SUPABASE_SERVICE_KEY
      - NEO_RPC_URL
      - NEO_NETWORK_MAGIC
    volumes:
      - /var/run/aesmd:/var/run/aesmd
      - /etc/sgx_default_qcnl.conf:/etc/sgx_default_qcnl.conf:ro
    devices:
      - /dev/sgx_enclave:/dev/sgx_enclave
      - /dev/sgx_provision:/dev/sgx_provision
    depends_on:
      - coordinator
    restart: unless-stopped

  # =============================================================================
  # NeoOracle Service Marble
  # =============================================================================
  neooracle:
    image: service-layer/neooracle:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile.service
      args:
        SERVICE: neooracle
        EGO_VERSION: ${EGO_VERSION:-1.8.0}
        EGO_STRICT_SIGNING: ${EGO_STRICT_SIGNING:-1}
    container_name: service-neooracle
    environment:
      - EDG_MARBLE_COORDINATOR_ADDR=${COORDINATOR_MESH_ADDR:-coordinator:2001}
      - EDG_MARBLE_TYPE=neooracle
      - EDG_MARBLE_DNS_NAMES=localhost,neooracle,oracle
      - SERVICE_TYPE=neooracle
      - OE_SIMULATION=${OE_SIMULATION:-0}
      - MARBLE_ENV=${MARBLE_ENV:-production}
      - SUPABASE_URL
      - SUPABASE_SERVICE_KEY
      - NEO_RPC_URL
      - NEO_NETWORK_MAGIC
      - SECRETS_MASTER_KEY
      - ORACLE_HTTP_ALLOWLIST
      - ORACLE_TIMEOUT
      - ORACLE_MAX_SIZE
    volumes:
      - /var/run/aesmd:/var/run/aesmd
      - /etc/sgx_default_qcnl.conf:/etc/sgx_default_qcnl.conf:ro
    devices:
      - /dev/sgx_enclave:/dev/sgx_enclave
      - /dev/sgx_provision:/dev/sgx_provision
    depends_on:
      - coordinator
    restart: unless-stopped

  # =============================================================================
  # NeoRequests Service Marble
  # =============================================================================
  neorequests:
    image: service-layer/neorequests:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile.service
      args:
        SERVICE: neorequests
        EGO_VERSION: ${EGO_VERSION:-1.8.0}
        EGO_STRICT_SIGNING: ${EGO_STRICT_SIGNING:-1}
    container_name: service-neorequests
    environment:
      - EDG_MARBLE_COORDINATOR_ADDR=${COORDINATOR_MESH_ADDR:-coordinator:2001}
      - EDG_MARBLE_TYPE=neorequests
      - EDG_MARBLE_DNS_NAMES=localhost,neorequests
      - SERVICE_TYPE=neorequests
      - OE_SIMULATION=${OE_SIMULATION:-0}
      - MARBLE_ENV=${MARBLE_ENV:-production}
      - SUPABASE_URL
      - SUPABASE_SERVICE_KEY
      - NEO_RPC_URL
      - NEO_NETWORK_MAGIC
      - CONTRACT_SERVICEGATEWAY_HASH
      - NEOVRF_URL
      - NEOORACLE_URL
      - NEOCOMPUTE_URL
      - NEOREQUESTS_MAX_RESULT_BYTES
      - NEOREQUESTS_MAX_ERROR_LEN
      - NEOREQUESTS_RNG_RESULT_MODE
      - NEOREQUESTS_TX_WAIT
      - NEOREQUESTS_ENFORCE_APPREGISTRY
      - NEOREQUESTS_APPREGISTRY_CACHE_SECONDS
      - TXPROXY_URL=${TXPROXY_URL:-https://txproxy:8090}
      - TXPROXY_TIMEOUT=${TXPROXY_TIMEOUT:-90s}
    volumes:
      - /var/run/aesmd:/var/run/aesmd
      - /etc/sgx_default_qcnl.conf:/etc/sgx_default_qcnl.conf:ro
    devices:
      - /dev/sgx_enclave:/dev/sgx_enclave
      - /dev/sgx_provision:/dev/sgx_provision
    depends_on:
      - coordinator
    restart: unless-stopped

  # =============================================================================
  # TxProxy Service Marble
  # =============================================================================
  txproxy:
    image: service-layer/txproxy:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile.service
      args:
        SERVICE: txproxy
        EGO_VERSION: ${EGO_VERSION:-1.8.0}
        EGO_STRICT_SIGNING: ${EGO_STRICT_SIGNING:-1}
    container_name: service-txproxy
    environment:
      - EDG_MARBLE_COORDINATOR_ADDR=${COORDINATOR_MESH_ADDR:-coordinator:2001}
      - EDG_MARBLE_TYPE=txproxy
      - EDG_MARBLE_DNS_NAMES=localhost,txproxy
      - SERVICE_TYPE=txproxy
      - OE_SIMULATION=${OE_SIMULATION:-0}
      - MARBLE_ENV=${MARBLE_ENV:-production}
      - SUPABASE_URL
      - SUPABASE_SERVICE_KEY
      - NEO_RPC_URL
      - NEO_NETWORK_MAGIC
      - CONTRACT_PAYMENTHUB_HASH
      - CONTRACT_GOVERNANCE_HASH
      - TXPROXY_ALLOWLIST
      - GLOBALSIGNER_SERVICE_URL=${GLOBALSIGNER_SERVICE_URL:-https://globalsigner:8092}
    volumes:
      - /var/run/aesmd:/var/run/aesmd
      - /etc/sgx_default_qcnl.conf:/etc/sgx_default_qcnl.conf:ro
    devices:
      - /dev/sgx_enclave:/dev/sgx_enclave
      - /dev/sgx_provision:/dev/sgx_provision
    depends_on:
      - coordinator
    restart: unless-stopped

  # =============================================================================
  # GlobalSigner Service Marble
  # =============================================================================
  globalsigner:
    image: service-layer/globalsigner:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile.service
      args:
        SERVICE: globalsigner
        EGO_VERSION: ${EGO_VERSION:-1.8.0}
        EGO_STRICT_SIGNING: ${EGO_STRICT_SIGNING:-1}
    container_name: service-globalsigner
    environment:
      - EDG_MARBLE_COORDINATOR_ADDR=${COORDINATOR_MESH_ADDR:-coordinator:2001}
      - EDG_MARBLE_TYPE=globalsigner
      - EDG_MARBLE_DNS_NAMES=localhost,globalsigner
      - SERVICE_TYPE=globalsigner
      - OE_SIMULATION=${OE_SIMULATION:-0}
      - PORT=${GLOBALSIGNER_PORT:-8092}
      - MARBLE_ENV=${MARBLE_ENV:-production}
      - SUPABASE_URL
      - SUPABASE_SERVICE_KEY
      - GLOBALSIGNER_MASTER_SEED
    volumes:
      - /var/run/aesmd:/var/run/aesmd
      - /etc/sgx_default_qcnl.conf:/etc/sgx_default_qcnl.conf:ro
    devices:
      - /dev/sgx_enclave:/dev/sgx_enclave
      - /dev/sgx_provision:/dev/sgx_provision
    depends_on:
      - coordinator
    restart: unless-stopped

volumes:
  coordinator-data:
