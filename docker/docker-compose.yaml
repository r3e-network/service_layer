services:
  # =============================================================================
  # MarbleRun Coordinator
  # =============================================================================
  coordinator:
    image: ${MARBLERUN_COORDINATOR_IMAGE:-ghcr.io/edgelesssys/marblerun/coordinator:v1.8.0}
    container_name: marblerun-coordinator
    ports:
      - 127.0.0.1:2001:2001
      - 127.0.0.1:4433:4433
    environment:
      - EDG_COORDINATOR_MESH_ADDR=0.0.0.0:2001
      - EDG_COORDINATOR_CLIENT_ADDR=0.0.0.0:4433
      - EDG_COORDINATOR_DNS_NAMES=localhost,coordinator
      - EDG_COORDINATOR_SEAL_DIR=/coordinator/data
      - OE_SIMULATION=${OE_SIMULATION:-0}
    volumes:
      - coordinator-data:/coordinator/data
      - ../manifests:/manifests:ro
      - /var/run/aesmd:/var/run/aesmd
      - /etc/sgx_default_qcnl.conf:/etc/sgx_default_qcnl.conf:ro
    devices:
      - /dev/sgx_enclave:/dev/sgx_enclave
      - /dev/sgx_provision:/dev/sgx_provision
    restart: unless-stopped

  # =============================================================================
  # Gateway Marble (API Gateway)
  # =============================================================================
  gateway:
    image: service-layer/gateway:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile.gateway
      args:
        EGO_VERSION: ${EGO_VERSION:-1.8.0}
        EGO_STRICT_SIGNING: ${EGO_STRICT_SIGNING:-1}
    container_name: service-gateway
    ports:
      - 127.0.0.1:${GATEWAY_PORT:-8080}:${GATEWAY_PORT:-8080}
    environment:
      - EDG_MARBLE_COORDINATOR_ADDR=${COORDINATOR_MESH_ADDR:-coordinator:2001}
      - EDG_MARBLE_TYPE=gateway
      - EDG_MARBLE_DNS_NAMES=localhost,gateway
      - EDG_MARBLE_UUID_FILE=/marble/uuid
      - OE_SIMULATION=${OE_SIMULATION:-0}
      - PORT=${GATEWAY_PORT:-8080}
      - MARBLE_ENV=${MARBLE_ENV:-production}
      - LOG_LEVEL
      - LOG_FORMAT
      - METRICS_ENABLED
      - ADMIN_USER_IDS
      - SUPER_ADMIN_USER_IDS
      - JWT_EXPIRY
      - RATE_LIMIT_ENABLED
      - RATE_LIMIT_REQUESTS
      - RATE_LIMIT_WINDOW
      - RATE_LIMIT_BURST
      - GATEWAY_TLS_MODE
      - SUPABASE_URL
      - SUPABASE_SERVICE_KEY
      - NEO_RPC_URL
      - CORS_ALLOWED_ORIGINS
      - FRONTEND_URL
      - OAUTH_REDIRECT_BASE
      - OAUTH_COOKIE_MODE
      - OAUTH_COOKIE_SAMESITE
      - GOOGLE_CLIENT_ID
      - GOOGLE_CLIENT_SECRET
      - GITHUB_CLIENT_ID
      - GITHUB_CLIENT_SECRET
      - SECRETS_MASTER_KEY
      - DATAFEEDS_SERVICE_URL=${DATAFEEDS_SERVICE_URL:-http://neofeeds:8083}
      - AUTOMATION_SERVICE_URL=${AUTOMATION_SERVICE_URL:-http://neoflow:8084}
      - ACCOUNTPOOL_SERVICE_URL=${ACCOUNTPOOL_SERVICE_URL:-http://neoaccounts:8085}
      - CONFIDENTIAL_SERVICE_URL=${CONFIDENTIAL_SERVICE_URL:-http://neocompute:8086}
      - ORACLE_SERVICE_URL=${ORACLE_SERVICE_URL:-http://neooracle:8088}
      - NEORAND_SERVICE_URL=${NEORAND_SERVICE_URL:-http://neorand:8087}
      - TXPROXY_SERVICE_URL=${TXPROXY_SERVICE_URL:-http://txproxy:8090}
    volumes:
      - gateway-data:/marble
      - /var/run/aesmd:/var/run/aesmd
      - /etc/sgx_default_qcnl.conf:/etc/sgx_default_qcnl.conf:ro
    devices:
      - /dev/sgx_enclave:/dev/sgx_enclave
      - /dev/sgx_provision:/dev/sgx_provision
    depends_on:
      - coordinator
    restart: unless-stopped

  # =============================================================================
  # NeoFeeds Service Marble
  # =============================================================================
  neofeeds:
    image: service-layer/neofeeds:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile.service
      args:
        SERVICE: neofeeds
        EGO_VERSION: ${EGO_VERSION:-1.8.0}
        EGO_STRICT_SIGNING: ${EGO_STRICT_SIGNING:-1}
    container_name: service-neofeeds
    environment:
      - EDG_MARBLE_COORDINATOR_ADDR=${COORDINATOR_MESH_ADDR:-coordinator:2001}
      - EDG_MARBLE_TYPE=neofeeds
      - EDG_MARBLE_DNS_NAMES=localhost,neofeeds
      - SERVICE_TYPE=neofeeds
      - OE_SIMULATION=${OE_SIMULATION:-0}
      - MARBLE_ENV=${MARBLE_ENV:-production}
      - SUPABASE_URL
      - SUPABASE_SERVICE_KEY
      - NEO_RPC_URL
      - NEO_NETWORK_MAGIC
      - ARBITRUM_RPC
      - BINANCE_API_KEY
      - CONTRACT_GATEWAY_HASH
      - CONTRACT_DATAFEEDS_HASH
      - TEE_PRIVATE_KEY
      - GLOBALSIGNER_SERVICE_URL=${GLOBALSIGNER_SERVICE_URL:-http://globalsigner:8092}
    volumes:
      - /var/run/aesmd:/var/run/aesmd
      - /etc/sgx_default_qcnl.conf:/etc/sgx_default_qcnl.conf:ro
    devices:
      - /dev/sgx_enclave:/dev/sgx_enclave
      - /dev/sgx_provision:/dev/sgx_provision
    depends_on:
      - coordinator
    restart: unless-stopped

  # =============================================================================
  # NeoFlow Service Marble
  # =============================================================================
  neoflow:
    image: service-layer/neoflow:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile.service
      args:
        SERVICE: neoflow
        EGO_VERSION: ${EGO_VERSION:-1.8.0}
        EGO_STRICT_SIGNING: ${EGO_STRICT_SIGNING:-1}
    container_name: service-neoflow
    environment:
      - EDG_MARBLE_COORDINATOR_ADDR=${COORDINATOR_MESH_ADDR:-coordinator:2001}
      - EDG_MARBLE_TYPE=neoflow
      - EDG_MARBLE_DNS_NAMES=localhost,neoflow
      - SERVICE_TYPE=neoflow
      - OE_SIMULATION=${OE_SIMULATION:-0}
      - MARBLE_ENV=${MARBLE_ENV:-production}
      - NEOFLOW_WEBHOOK_ALLOW_PRIVATE_NETWORKS
      - SUPABASE_URL
      - SUPABASE_SERVICE_KEY
      - NEO_RPC_URL
      - NEO_NETWORK_MAGIC
      - CONTRACT_GATEWAY_HASH
      - CONTRACT_AUTOMATION_HASH
      - NEOFLOW_SCHEDULER_USER_ID
      - TEE_PRIVATE_KEY
      - GLOBALSIGNER_SERVICE_URL=${GLOBALSIGNER_SERVICE_URL:-http://globalsigner:8092}
    volumes:
      - /var/run/aesmd:/var/run/aesmd
      - /etc/sgx_default_qcnl.conf:/etc/sgx_default_qcnl.conf:ro
    devices:
      - /dev/sgx_enclave:/dev/sgx_enclave
      - /dev/sgx_provision:/dev/sgx_provision
    depends_on:
      - coordinator
    restart: unless-stopped

  # =============================================================================
  # AccountPool Service Marble (Internal)
  # =============================================================================
  neoaccounts:
    image: service-layer/neoaccounts:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile.service
      args:
        SERVICE: accountpool
        EGO_VERSION: ${EGO_VERSION:-1.8.0}
        EGO_STRICT_SIGNING: ${EGO_STRICT_SIGNING:-1}
    container_name: service-accountpool
    environment:
      - EDG_MARBLE_COORDINATOR_ADDR=${COORDINATOR_MESH_ADDR:-coordinator:2001}
      - EDG_MARBLE_TYPE=neoaccounts
      - EDG_MARBLE_DNS_NAMES=localhost,neoaccounts,accountpool
      - SERVICE_TYPE=neoaccounts
      - OE_SIMULATION=${OE_SIMULATION:-0}
      - MARBLE_ENV=${MARBLE_ENV:-production}
      - SUPABASE_URL
      - SUPABASE_SERVICE_KEY
      - NEO_RPC_URL
      - NEO_NETWORK_MAGIC
      - GLOBALSIGNER_SERVICE_URL=${GLOBALSIGNER_SERVICE_URL:-http://globalsigner:8092}
    volumes:
      - /var/run/aesmd:/var/run/aesmd
      - /etc/sgx_default_qcnl.conf:/etc/sgx_default_qcnl.conf:ro
    devices:
      - /dev/sgx_enclave:/dev/sgx_enclave
      - /dev/sgx_provision:/dev/sgx_provision
    depends_on:
      - coordinator
    restart: unless-stopped

  # =============================================================================
  # NeoCompute Service Marble
  # =============================================================================
  neocompute:
    image: service-layer/neocompute:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile.service
      args:
        SERVICE: neocompute
        EGO_VERSION: ${EGO_VERSION:-1.8.0}
        EGO_STRICT_SIGNING: ${EGO_STRICT_SIGNING:-1}
    container_name: service-neocompute
    environment:
      - EDG_MARBLE_COORDINATOR_ADDR=${COORDINATOR_MESH_ADDR:-coordinator:2001}
      - EDG_MARBLE_TYPE=neocompute
      - EDG_MARBLE_DNS_NAMES=localhost,neocompute
      - SERVICE_TYPE=neocompute
      - OE_SIMULATION=${OE_SIMULATION:-0}
      - MARBLE_ENV=${MARBLE_ENV:-production}
      - SUPABASE_URL
      - SUPABASE_SERVICE_KEY
      - NEO_RPC_URL
      - NEO_NETWORK_MAGIC
      - SECRETS_MASTER_KEY
      - CONTRACT_GATEWAY_HASH
      - CONTRACT_CONFIDENTIAL_HASH
      - TEE_PRIVATE_KEY
      - NEOCOMPUTE_RESULT_TTL
      - GLOBALSIGNER_SERVICE_URL=${GLOBALSIGNER_SERVICE_URL:-http://globalsigner:8092}
    volumes:
      - /var/run/aesmd:/var/run/aesmd
      - /etc/sgx_default_qcnl.conf:/etc/sgx_default_qcnl.conf:ro
    devices:
      - /dev/sgx_enclave:/dev/sgx_enclave
      - /dev/sgx_provision:/dev/sgx_provision
    depends_on:
      - coordinator
    restart: unless-stopped

  # =============================================================================
  # NeoOracle Service Marble
  # =============================================================================
  neooracle:
    image: service-layer/neooracle:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile.service
      args:
        SERVICE: neooracle
        EGO_VERSION: ${EGO_VERSION:-1.8.0}
        EGO_STRICT_SIGNING: ${EGO_STRICT_SIGNING:-1}
    container_name: service-neooracle
    environment:
      - EDG_MARBLE_COORDINATOR_ADDR=${COORDINATOR_MESH_ADDR:-coordinator:2001}
      - EDG_MARBLE_TYPE=neooracle
      - EDG_MARBLE_DNS_NAMES=localhost,neooracle,oracle
      - SERVICE_TYPE=neooracle
      - OE_SIMULATION=${OE_SIMULATION:-0}
      - MARBLE_ENV=${MARBLE_ENV:-production}
      - SUPABASE_URL
      - SUPABASE_SERVICE_KEY
      - NEO_RPC_URL
      - NEO_NETWORK_MAGIC
      - SECRETS_MASTER_KEY
      - ORACLE_HTTP_ALLOWLIST
      - ORACLE_TIMEOUT
      - ORACLE_MAX_SIZE
      - CONTRACT_GATEWAY_HASH
      - CONTRACT_ORACLE_HASH
      - TEE_PRIVATE_KEY
      - GLOBALSIGNER_SERVICE_URL=${GLOBALSIGNER_SERVICE_URL:-http://globalsigner:8092}
    volumes:
      - /var/run/aesmd:/var/run/aesmd
      - /etc/sgx_default_qcnl.conf:/etc/sgx_default_qcnl.conf:ro
    devices:
      - /dev/sgx_enclave:/dev/sgx_enclave
      - /dev/sgx_provision:/dev/sgx_provision
    depends_on:
      - coordinator
    restart: unless-stopped

  # =============================================================================
  # NeoRand Service Marble (VRF)
  # =============================================================================
  neorand:
    image: service-layer/neorand:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile.service
      args:
        SERVICE: neorand
        EGO_VERSION: ${EGO_VERSION:-1.8.0}
        EGO_STRICT_SIGNING: ${EGO_STRICT_SIGNING:-1}
    container_name: service-neorand
    environment:
      - EDG_MARBLE_COORDINATOR_ADDR=${COORDINATOR_MESH_ADDR:-coordinator:2001}
      - EDG_MARBLE_TYPE=neorand
      - EDG_MARBLE_DNS_NAMES=localhost,neorand
      - SERVICE_TYPE=neorand
      - OE_SIMULATION=${OE_SIMULATION:-0}
      - MARBLE_ENV=${MARBLE_ENV:-production}
      - SUPABASE_URL
      - SUPABASE_SERVICE_KEY
      - NEO_RPC_URL
      - NEO_NETWORK_MAGIC
      - CONTRACT_RANDOMNESSLOG_HASH
      - VRF_PRIVATE_KEY
      - GLOBALSIGNER_SERVICE_URL=${GLOBALSIGNER_SERVICE_URL:-http://globalsigner:8092}
    volumes:
      - /var/run/aesmd:/var/run/aesmd
      - /etc/sgx_default_qcnl.conf:/etc/sgx_default_qcnl.conf:ro
    devices:
      - /dev/sgx_enclave:/dev/sgx_enclave
      - /dev/sgx_provision:/dev/sgx_provision
    depends_on:
      - coordinator
    restart: unless-stopped

  # =============================================================================
  # TxProxy Service Marble
  # =============================================================================
  txproxy:
    image: service-layer/txproxy:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile.service
      args:
        SERVICE: txproxy
        EGO_VERSION: ${EGO_VERSION:-1.8.0}
        EGO_STRICT_SIGNING: ${EGO_STRICT_SIGNING:-1}
    container_name: service-txproxy
    environment:
      - EDG_MARBLE_COORDINATOR_ADDR=${COORDINATOR_MESH_ADDR:-coordinator:2001}
      - EDG_MARBLE_TYPE=txproxy
      - EDG_MARBLE_DNS_NAMES=localhost,txproxy
      - SERVICE_TYPE=txproxy
      - OE_SIMULATION=${OE_SIMULATION:-0}
      - MARBLE_ENV=${MARBLE_ENV:-production}
      - SUPABASE_URL
      - SUPABASE_SERVICE_KEY
      - NEO_RPC_URL
      - NEO_NETWORK_MAGIC
      - TXPROXY_ALLOWLIST
      - GLOBALSIGNER_SERVICE_URL=${GLOBALSIGNER_SERVICE_URL:-http://globalsigner:8092}
    volumes:
      - /var/run/aesmd:/var/run/aesmd
      - /etc/sgx_default_qcnl.conf:/etc/sgx_default_qcnl.conf:ro
    devices:
      - /dev/sgx_enclave:/dev/sgx_enclave
      - /dev/sgx_provision:/dev/sgx_provision
    depends_on:
      - coordinator
    restart: unless-stopped

  # =============================================================================
  # GlobalSigner Service Marble
  # =============================================================================
  globalsigner:
    image: service-layer/globalsigner:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile.service
      args:
        SERVICE: globalsigner
        EGO_VERSION: ${EGO_VERSION:-1.8.0}
        EGO_STRICT_SIGNING: ${EGO_STRICT_SIGNING:-1}
    container_name: service-globalsigner
    environment:
      - EDG_MARBLE_COORDINATOR_ADDR=${COORDINATOR_MESH_ADDR:-coordinator:2001}
      - EDG_MARBLE_TYPE=globalsigner
      - EDG_MARBLE_DNS_NAMES=localhost,globalsigner
      - SERVICE_TYPE=globalsigner
      - OE_SIMULATION=${OE_SIMULATION:-0}
      - PORT=${GLOBALSIGNER_PORT:-8092}
      - MARBLE_ENV=${MARBLE_ENV:-production}
      - SUPABASE_URL
      - SUPABASE_SERVICE_KEY
      - GLOBALSIGNER_MASTER_SEED
    volumes:
      - /var/run/aesmd:/var/run/aesmd
      - /etc/sgx_default_qcnl.conf:/etc/sgx_default_qcnl.conf:ro
    devices:
      - /dev/sgx_enclave:/dev/sgx_enclave
      - /dev/sgx_provision:/dev/sgx_provision
    depends_on:
      - coordinator
    restart: unless-stopped

volumes:
  coordinator-data:
  gateway-data:
